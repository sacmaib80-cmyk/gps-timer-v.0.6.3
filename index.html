<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QPS Timer v0.5.4 (Morning Gate v4 ‚Ä¢ Lock 7 Days)</title>

  <style>
    :root{
      --bg:#f6f9ff;
      --bg2:#eef7ff;

      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;

      --accent:#22c55e;
      --accent2:#60a5fa;
      --warn:#fb7185;
      --gold:#f59e0b;

      --border: rgba(15,23,42,.12);
      --shadow: 0 12px 28px rgba(2,6,23,.10);

      --r:16px;
      --r2:22px;

      --focus: rgba(96,165,250,.35);

      /* Gate colors */
      --gateRed1:#ff3b5c;
      --gateRed2:#b91c1c;
      --gateRed3:#7f1d1d;
      --gateText:#fff;

      --gateGreen1:#22c55e;
      --gateGreen2:#16a34a;
      --gateGreen3:#14532d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1100px 700px at 12% 8%, rgba(96,165,250,.26), transparent 55%),
        radial-gradient(1000px 700px at 86% 18%, rgba(34,197,94,.22), transparent 52%),
        radial-gradient(900px 700px at 48% 92%, rgba(245,158,11,.14), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow:hidden;
    }

    .app{
      height:100vh;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 12px 56px;
      position: relative;
    }
    .container{ max-width: 860px; margin: 0 auto; }

    /* topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      margin: 0 auto 12px;
      padding: 10px 10px 12px;
      background: linear-gradient(180deg, rgba(246,249,255,.98), rgba(246,249,255,.84), rgba(246,249,255,.00));
      backdrop-filter: blur(10px);
    }
    .topbarRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .brand h1{ margin:0; font-size: 18px; line-height:1.2; display:flex; align-items:center; gap:10px; }
    .brand .sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }

    .pills{
      display:flex; gap:8px; align-items:flex-start;
      flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
      font-size:12px; color:var(--muted);
    }
    .pill b{ color:var(--ink); }

    .pillBtn{
      border:0;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      background: rgba(2,6,23,.06);
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow:none;
    }
    .pillBtn.on{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.28);
      color:#166534;
    }
    .pillBtn:disabled{ opacity:.45; cursor:not-allowed; }

    .jump{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .jump button{
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
    }

    .section{ margin-top: 12px; scroll-margin-top: 110px; }
    .sectionHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 6px 2px 10px;
    }
    .sectionHead h2{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }

    .card{
      background: rgba(255,255,255,.94);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 14px;
      max-width: 760px;
      margin: 0 auto;
    }
    .divider{ height:1px; background: var(--border); margin: 12px 0; }

    .row{ display:grid; gap:10px; grid-template-columns: 1fr; }
    .row.two{ grid-template-columns: 1fr; }
    @media(min-width:720px){
      .row.two{ grid-template-columns: 1fr 1fr; }
    }
    .row.three{ grid-template-columns: 1fr; }
    @media(min-width:720px){
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; color:var(--muted); font-size: 12px; margin-bottom: 6px; }
    input,select,textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: white;
      color: var(--ink);
      padding: 12px;
      outline:none;
      font-size: 14px;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }
    textarea{ min-height: 96px; resize: vertical; }

    select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      height: 48px;
      padding: 12px 40px 12px 12px;
      background-color: white;
      background-image:
        linear-gradient(45deg, transparent 50%, #64748b 50%),
        linear-gradient(135deg, #64748b 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    button{
      border:0;
      border-radius: 14px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      color: white;
      background: linear-gradient(180deg, var(--accent), #16a34a);
      box-shadow: 0 10px 20px rgba(34,197,94,.18);
    }
    button.secondary{
      color: var(--ink);
      background: rgba(2,6,23,.05);
      border: 1px solid var(--border);
      box-shadow:none;
    }
    button.danger{
      color: #7f1d1d;
      background: rgba(251,113,133,.20);
      border: 1px solid rgba(251,113,133,.34);
      box-shadow:none;
    }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .btns{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media(min-width:720px){
      .btns{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }

    .timer{
      font-variant-numeric: tabular-nums;
      font-size: 44px;
      letter-spacing: 1px;
      margin: 10px 0 4px;
    }
    .hint{ color: var(--muted); font-size:12px; margin-top:8px; line-height:1.45; }
    .ok{ color:#15803d; font-size:12px; margin-top:8px; }
    .warnText{ color:#be123c; font-size:12px; margin-top:8px; line-height:1.45; }

    .progressWrap{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86);
      color: var(--muted);
      font-size: 12px;
    }
    .badge b{ color: var(--ink); }

    .miniRight{ display:flex; flex-wrap:wrap; gap:8px; }
    .smallBtn{ padding: 9px 10px; font-size: 12px; border-radius: 12px; }

    .bar{
      margin-top:12px;
      background: rgba(2,6,23,.06);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
      height: 14px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width 240ms ease;
    }

    .list{ display:grid; gap:10px; margin-top: 12px; }
    .item{
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.96);
      padding: 10px 12px;
    }
    .itemTop{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .itemName{ font-weight: 900; }
    .itemMeta{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .itemScore{
      font-weight: 950;
      color: #16a34a;
      font-variant-numeric: tabular-nums;
    }

    /* help tooltip */
    .helpBtn{
      width:22px; height:22px;
      border-radius: 999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight: 950;
      font-size: 12px;
      color: rgba(15,23,42,.75);
      background: rgba(2,6,23,.04);
      border: 1px solid var(--border);
      box-shadow:none;
      padding:0;
      cursor:pointer;
    }
    .helpBtn:hover{
      background: rgba(96,165,250,.12);
      border-color: rgba(96,165,250,.24);
    }
    .tooltip{
      position: absolute;
      z-index: 9998;
      width: min(340px, calc(100vw - 24px));
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(15,23,42,.16);
      border-radius: 16px;
      box-shadow: 0 16px 36px rgba(2,6,23,.18);
      padding: 12px 12px 10px;
      display:none;
    }
    .tooltip.show{ display:block; }
    .tooltip .tTitle{ font-weight: 950; margin: 0 0 6px; }
    .tooltip .tBody{ margin:0; color: var(--muted); font-size: 12px; line-height:1.5; white-space:pre-line; }
    .tooltip .tActions{ display:flex; justify-content:flex-end; margin-top:10px; }
    .tooltip .tActions button{ padding:8px 10px; font-size:12px; border-radius: 12px; }

    .tipArrow{
      position: absolute;
      z-index: 9997;
      width: 14px; height: 14px;
      background: rgba(255,255,255,.98);
      border-left: 1px solid rgba(15,23,42,.16);
      border-top: 1px solid rgba(15,23,42,.16);
      transform: rotate(45deg);
      display:none;
    }
    .tipArrow.show{ display:block; }

    /* overlays */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }

    .sheet{
      width: min(980px, 100vw);
      max-height: 86vh;
      background: rgba(255,255,255,.98);
      border: 1px solid var(--border);
      border-radius: 22px 22px 0 0;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(96,165,250,.12), rgba(255,255,255,.0));
    }
    .sheetGrid{
      display:grid; gap:12px;
      padding: 12px 14px 14px;
      grid-template-columns: 1fr;
    }
    @media(min-width:820px){
      .sheetGrid{ grid-template-columns: .9fr 1.1fr; }
    }
    .dayList{
      max-height: 56vh;
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(2,6,23,.03);
      padding: 8px;
    }
    .dayBtn{
      width:100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 900;
      color: var(--ink);
      cursor:pointer;
    }
    .dayBtn:hover{ background: rgba(96,165,250,.14); border-color: rgba(96,165,250,.22); }
    .dayBtn.active{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.22); }

    .dayView{
      max-height: 56vh;
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(2,6,23,.03);
      padding: 10px;
    }

    /* onboarding */
    .onboard{
      width: min(720px, calc(100vw - 24px));
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(15,23,42,.16);
      border-radius: 22px;
      box-shadow: 0 18px 44px rgba(2,6,23,.22);
      padding: 14px;
      margin: 0 0 16px;
    }
    .onTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .onTitle{ margin:0; font-size: 16px; font-weight: 950; }
    .onSub{ margin:6px 0 0; font-size: 12px; color: var(--muted); line-height: 1.5; }
    .onSteps{ margin: 10px 0 0; padding-left: 16px; color: var(--ink); font-size: 13px; line-height: 1.55; }
    .onSteps li{ margin: 6px 0; }
    .onBtns{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .onBtns button{ padding: 10px 12px; font-size: 13px; border-radius: 14px; }

    /* report buttons */
    #reportCard .btns{ display:flex; align-items:center; gap:12px; }
    #submitReportBtn{ flex:1; padding: 12px 16px; font-size: 16px; font-weight: 900; border-radius: 16px; }
    #discardBtn{ flex:0 0 auto; padding: 10px 14px; font-size: 13px; border-radius: 12px; }

    /* Cutting Time module */
    .cutWrap{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.02);
      overflow: hidden;
    }
    .cutHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px;
    }
    .cutBtn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;

      padding: 12px 14px;
      border-radius: 16px;

      color: var(--ink);
      background: rgba(2,6,23,.04);
      border: 1px solid var(--border);
      box-shadow:none;
      font-weight: 950;
      cursor:pointer;
    }
    .cutChip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      color: var(--muted);
      font-weight: 950;
    }
    .cutWrap.open{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.20);
      background:
        radial-gradient(520px 180px at 14% 0%, rgba(96,165,250,.20), transparent 60%),
        rgba(2,6,23,.02);
    }
    .cutWrap.open .cutBtn{
      background: linear-gradient(180deg, rgba(96,165,250,.16), rgba(34,197,94,.10));
      border-color: rgba(96,165,250,.35);
    }
    .cutWrap.open .cutChip{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.28);
      color:#166534;
    }
    .cutBody{ padding: 0 12px 12px; }
    .smallHint{ font-size: 11px; color: var(--muted); margin-top: 6px; line-height: 1.4; }

    /* =========================
       MORNING GATE (v4 ‚Ä¢ lock 7 days)
    ========================= */
    .gateCover{
      position: fixed;
      inset: 0;
      z-index: 10050;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;

      background:
        radial-gradient(900px 600px at 20% 20%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(700px 520px at 80% 30%, rgba(0,0,0,.12), transparent 60%),
        linear-gradient(160deg, rgba(255,59,92,.82), rgba(185,28,28,.82) 55%, rgba(127,29,29,.82));
      color: var(--gateText);
      backdrop-filter: blur(10px);
      pointer-events: auto;
    }
    .gateCover.show{ display:flex; }

    .gatePanel{
      width: min(680px, 100%);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      box-shadow: 0 26px 70px rgba(0,0,0,.34);
      backdrop-filter: blur(12px);
      overflow: hidden;
    }
    .gatePanelHead{
      padding: 16px 16px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,0));
    }
    .gateTitle{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .gateKicker{
      margin: 6px 0 0;
      font-size: 12px;
      opacity:.9;
      line-height:1.55;
    }
    .gatePanelBody{
      padding: 14px 16px 16px;
      display:grid;
      gap:12px;
    }

    .gateChip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }

    .gateInlineEdit{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
    }

    .gateBigTime{
      font-variant-numeric: tabular-nums;
      font-size: 46px;
      font-weight: 950;
      letter-spacing: 1px;
      text-align:center;
      padding: 6px 0 0;
      text-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .gateSubHint{
      text-align:center;
      font-size: 12px;
      opacity: .92;
      line-height:1.55;
    }

    .gateActions{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 4px;
    }
    .gateBtnPrimary{
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 950;
      color: #111827;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
      border: 1px solid rgba(255,255,255,.30);
      box-shadow: 0 16px 40px rgba(0,0,0,.22);
      touch-action: manipulation;
    }

    .gateTopBar{
      position: fixed;
      left: 0; right: 0; top: 0;
      z-index: 10040;
      display:none;
      padding: 10px 12px;
      background:
        radial-gradient(900px 160px at 20% 0%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(160deg, var(--gateRed1), var(--gateRed2) 60%, var(--gateRed3));
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 42px rgba(0,0,0,.26);
      pointer-events: auto;
    }
    .gateTopBar.show{ display:block; }

    .gateTopBar.done{
      background:
        radial-gradient(900px 160px at 20% 0%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(160deg, var(--gateGreen1), var(--gateGreen2) 60%, var(--gateGreen3));
    }

    .gateTopInner{
      max-width: 860px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gateTopLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .gateTopTitle{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.2px;
      opacity:.95;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .gateTopSub{
      font-size: 12px;
      opacity:.9;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .gateTopTime{
      font-variant-numeric: tabular-nums;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.14);
      white-space:nowrap;
    }
    .gateTopBtn{
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      color: #111827;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.30);
      box-shadow:none;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .gateTopBtn.secondaryDark{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.16);
    }

    body.gateBarOn .app{ padding-top: 64px; }
    @media(min-width:720px){
      body.gateBarOn .app{ padding-top: 66px; }
    }

    /* Morning Gate settings box */
    .gateSettings{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.02);
      padding: 12px;
    }
    .gateSettingsHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .gateSettingsTitle{
      display:flex; align-items:center; gap:10px;
      font-weight: 950; font-size: 13px;
    }
    .gateTinyPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86);
      font-size: 12px;
      color: var(--muted);
      font-weight: 950;
      white-space:nowrap;
    }
    .gateTinyPill b{ color: var(--ink); }
  </style>
</head>

<body>
  <!-- MORNING GATE COVER -->
  <div class="gateCover" id="gateCover" aria-hidden="true">
    <div class="gatePanel" role="dialog" aria-modal="true">
      <div class="gatePanelHead">
        <div>
          <p class="gateTitle">üü• Morning Gate</p>
          <p class="gateKicker" id="gateCoverKicker">
            ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ ‚ÄúTrigger Time‚Äù ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ<br>
            ‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö 3 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠ PASS
          </p>
        </div>
        <div class="gateChip" id="gateCoverStatusChip">STATUS: READY</div>
      </div>

      <div class="gatePanelBody">
        <div class="gateInlineEdit">
          <div class="gateChip" style="background: rgba(255,255,255,.10);">
            TRIGGER: <b id="gateTriggerDisplay">--.--</b>
          </div>
          <div class="gateChip" style="background: rgba(255,255,255,.10);">
            LIMIT: <b id="gateLimitDisplay">10m</b>
          </div>
          <div class="gateChip" style="background: rgba(255,255,255,.10);">
            QUALIFY: <b id="gateQualifyDisplay">3m</b>
          </div>
        </div>

        <div class="gateBigTime" id="gateCoverTime">--:--</div>
        <div class="gateSubHint" id="gateCoverHint">
          ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Trigger ‡πÅ‡∏•‡πâ‡∏ß: ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏° Morning Gate‚Äù ‚Üí ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </div>

        <div class="gateActions">
          <button class="gateBtnPrimary" type="button" id="gateCoverStartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏° Morning Gate</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MORNING GATE TOP BAR -->
  <div class="gateTopBar" id="gateTopBar">
    <div class="gateTopInner">
      <div class="gateTopLeft">
        <div class="gateTopTitle" id="gateTopTitle">Morning Gate ‚Ä¢ Running</div>
        <div class="gateTopSub" id="gateTopSub">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="gateTopTime" id="gateTopTime">00:00</div>
        <button class="gateTopBtn secondaryDark" type="button" id="gateTopOpenBtn">Gate</button>
      </div>
    </div>
  </div>

  <div class="app" id="appScroll">
    <div class="container">

      <div class="topbar">
        <div class="topbarRow">
          <div class="brand">
            <h1>
              QPS Timer v0.5.4
              <button class="helpBtn" type="button" data-tip="top">?</button>
            </h1>
            <div class="sub" id="todayText">Today: ----</div>
          </div>

          <div class="pills">
            <div class="pill" id="statusPill">Status: <b>Idle</b></div>
            <div class="pill" id="streakPill">üî• Streak: <b>0</b> ‚Ä¢ Best: <b>0</b></div>

            <div class="pill" style="gap:10px;">
              üü• Morning Gate
              <button class="pillBtn" id="gateToggleBtn" type="button">OFF</button>
            </div>
          </div>
        </div>

        <div class="jump">
          <button class="secondary" type="button" onclick="scrollToId('sec-timer')">‚è± Timer</button>
          <button class="secondary" type="button" onclick="scrollToId('sec-today')">üìã Today</button>
          <button class="secondary" type="button" onclick="scrollToId('sec-report')">üìù Report</button>
          <button class="secondary" type="button" id="openOnboardBtn">‚ú® How to use</button>
        </div>
      </div>

      <!-- TIMER -->
      <div class="section" id="sec-timer">
        <div class="sectionHead">
          <h2>Timer <button class="helpBtn" type="button" data-tip="timer">?</button></h2>
        </div>

        <div class="card">
          <div class="row two">
            <div>
              <label for="category">Quest Category</label>
              <select id="category">
                <option value="Learning">Learning</option>
                <option value="Work/Project">Work/Project</option>
                <option value="Physical">Physical</option>
                <option value="Connection">Connection</option>
              </select>
              <div class="hint">‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏õ‡πâ‡∏≤‡∏¢ (tag)</div>
            </div>
            <div>
              <label for="questName">
                Quest Name (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                <button class="helpBtn" type="button" data-tip="name">?</button>
              </label>
              <input id="questName" placeholder="‡πÄ‡∏ä‡πà‡∏ô English Drill / Logic 45 / Pushups" />
              <div class="warnText" id="nameWarn" style="display:none;"></div>
            </div>
          </div>

          <!-- Morning Gate Settings (‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô ON ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á) -->
          <div class="gateSettings" id="gateSettingsBox" style="display:none;">
            <div class="gateSettingsHead">
              <div class="gateSettingsTitle">
                üü• Morning Gate Settings
                <button class="helpBtn" type="button" data-tip="gate">?</button>
                <span class="gateTinyPill">Bonus: <b>+6</b> (PASS ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô deadline)</span>
              </div>
              <div class="hint" style="margin:0;">
                ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏¢‡∏∂‡∏î ‚Äú‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏•‡∏Å‡∏à‡∏£‡∏¥‡∏á‚Äù ‡∏ï‡∏≤‡∏° Trigger Time (‡∏Å‡∏±‡∏ô‡πÇ‡∏Å‡∏á)
              </div>
            </div>

            <div class="divider"></div>

            <div class="row two">
              <div>
                <label for="gateTriggerTimeInput">Trigger Time (‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á)</label>
                <input id="gateTriggerTimeInput" type="time" />
                <div class="smallHint" id="gateTriggerHint"></div>
              </div>

              <div>
                <label>Rules</label>
                <input type="text" value="Limit 10 ‡∏ô‡∏≤‡∏ó‡∏µ (fix) ‚Ä¢ Qualify 3 ‡∏ô‡∏≤‡∏ó‡∏µ (fix) ‚Ä¢ Lock 7 ‡∏ß‡∏±‡∏ô" disabled />
                <div class="smallHint">‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á Trigger ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ (‡∏Å‡∏±‡∏ô‡πÇ‡∏Å‡∏á)</div>
              </div>
            </div>

            <div class="hint" style="margin-top:10px;">
              ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢ deadline ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î LOCKED ‡∏ï‡πâ‡∏≠‡∏á Unlock ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏∞‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î)
            </div>
          </div>

          <div class="cutWrap" id="cutWrap">
            <div class="cutHeader">
              <button class="cutBtn" type="button" id="cutToggleBtn">
                ‚è≥ Set Time (Optional)
                <span class="cutChip" id="cutChip">OFF</span>
              </button>
              <button class="helpBtn" type="button" data-tip="cut">?</button>
            </div>

            <div class="cutBody" id="cutBody" style="display:none;">
              <div class="row two">
                <div>
                  <label for="cutMinutes">Cutting Time (minutes)</label>
                  <input id="cutMinutes" type="number" inputmode="numeric" min="1" max="360" step="1"
                         placeholder="‡πÄ‡∏ä‡πà‡∏ô 60 (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà = ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤)" />
                  <div class="smallHint">‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Stop ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Report</div>
                </div>

                <div>
                  <label for="cutMode">Mode</label>
                  <select id="cutMode">
                    <option value="hard" selected>Hard stop (‡∏ñ‡∏∂‡∏á‡∏õ‡∏∏‡πä‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</option>
                    <option value="soft">Soft stop (‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 10 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î)</option>
                  </select>
                  <div class="smallHint">Soft stop = ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="timer" id="timerText">00:00:00</div>
          <div class="hint" id="timerHint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start</div>
          <div class="warnText" id="timerWarn" style="display:none;"></div>

          <div class="btns" style="margin-top:12px;">
            <button id="startBtn" type="button">Start</button>
            <button id="stopBtn" class="danger" type="button" disabled>Stop</button>
            <button id="pauseBtn" class="secondary" type="button" disabled>Pause</button>
            <button id="resumeBtn" class="secondary" type="button" disabled>Resume</button>
          </div>

          <div class="hint" style="margin-top:12px;">
            Base = minutes √ó 0.4 ‚Ä¢ Bonus = 0/+2/+4/+6 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ‚â• 30 ‡∏ô‡∏≤‡∏ó‡∏µ) ‚Ä¢
            <b>Cap:</b> Base cap ‡∏ï‡πà‡∏≠ ‚ÄúQuest Name‚Äù ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô = 60 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
          </div>

          <div class="hint" style="margin-top:8px;">
            <b>Morning Gate (‡∏ñ‡πâ‡∏≤ ON ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Trigger ‡πÅ‡∏•‡πâ‡∏ß):</b>
            Gate ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á Trigger Time ‚Ä¢ PASS ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö <b>3 ‡∏ô‡∏≤‡∏ó‡∏µ</b> ‚Ä¢ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +6 ‡∏ñ‡πâ‡∏≤ PASS ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <b>10 ‡∏ô‡∏≤‡∏ó‡∏µ</b>
          </div>
        </div>
      </div>

      <!-- TODAY -->
      <div class="section" id="sec-today">
        <div class="sectionHead">
          <h2>Today <button class="helpBtn" type="button" data-tip="today">?</button></h2>
        </div>

        <div class="card">
          <div class="progressWrap">
            <div class="badge">Today's Total: <b id="todayTotal">0.0</b> / 100</div>
            <div class="miniRight">
              <button id="historyBtn" class="secondary smallBtn" type="button">History</button>
              <button id="undoBtn" class="secondary smallBtn" type="button" disabled>Undo</button>
              <button id="redoBtn" class="secondary smallBtn" type="button" disabled>Redo</button>
              <button id="resetTodayBtn" class="danger smallBtn" type="button">Reset Today</button>
            </div>
          </div>

          <div class="bar"><div id="progressFill"></div></div>

          <div class="divider"></div>

          <div class="row two">
            <div>
              <button id="exportBtn" class="secondary" type="button"
                style="width:100%;padding:10px 12px;font-size:13px;">Export</button>
            </div>
            <div>
              <button id="importBtn" class="secondary" type="button"
                style="width:100%;padding:10px 12px;font-size:13px;">Import</button>
              <input id="importFile" type="file" accept="application/json" style="display:none;">
            </div>
          </div>

          <div class="list" id="todayList"></div>
        </div>
      </div>

      <!-- REPORT -->
      <div class="section" id="sec-report">
        <div class="sectionHead">
          <h2>Report <button class="helpBtn" type="button" data-tip="report">?</button></h2>
        </div>

        <div class="card" id="reportCard" style="display:none;">
          <div class="badge">Report Quest</div>

          <div class="row two" style="margin-top:12px;">
            <div>
              <label for="reportMinutes">Minutes Spent</label>
              <input id="reportMinutes" type="number" min="0" step="1" />
              <div class="hint" id="bonusRuleHint"></div>
              <div class="hint" id="capHint"></div>
            </div>

            <div>
              <label for="qualityBonus">Quality Bonus</label>
              <select id="qualityBonus">
                <option value="0">0</option>
                <option value="2">+2</option>
                <option value="4">+4</option>
                <option value="6">+6</option>
              </select>
              <div class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô +6)</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£/‡πÑ‡∏î‡πâ insight ‡∏≠‡∏∞‡πÑ‡∏£/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏´‡∏°"></textarea>
          </div>

          <div class="btns" style="margin-top:12px;">
            <button id="submitReportBtn" type="button">Submit</button>
            <button id="discardBtn" class="secondary" type="button">Discard</button>
          </div>

          <div class="ok" id="submitOk" style="display:none;"></div>
          <div class="warnText" id="submitWarn" style="display:none;"></div>
        </div>

        <div class="hint" id="reportHiddenHint">* Report ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Stop ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>

    </div>

    <!-- TOOLTIP -->
    <div class="tooltip" id="tooltip">
      <div class="tTitle" id="tipTitle">Tip</div>
      <p class="tBody" id="tipBody"></p>
      <div class="tActions">
        <button class="secondary" type="button" id="tipCloseBtn">Close</button>
      </div>
    </div>
    <div class="tipArrow" id="tipArrow"></div>
  </div>

  <!-- HISTORY OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetHead">
        <div class="badge">History ‚Ä¢ <b id="histTitle">----</b></div>
        <button id="closeOverlayBtn" class="secondary" type="button"
          style="padding:10px 12px;font-size:13px;">Close</button>
      </div>

      <div class="sheetGrid">
        <div>
          <div class="hint" style="margin-bottom:8px;">Days</div>
          <div class="dayList" id="dayList"></div>
        </div>
        <div>
          <div class="hint" style="margin-bottom:8px;">Selected Day</div>
          <div class="dayView" id="dayView"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ONBOARDING -->
  <div class="overlay" id="onOverlay">
    <div class="onboard">
      <div class="onTop">
        <div>
          <p class="onTitle">‚ú® ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)</p>
          <p class="onSub">
            ‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí Report ‚Üí ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‚Äù ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ß<br>
            ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>?</b> ‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </p>
        </div>
      </div>

      <ol class="onSteps">
        <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>Category</b> ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á <b>Quest Name</b> (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</li>
        <li>‡∏Å‡∏î <b>Start</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</li>
        <li>‡∏Å‡∏î <b>Stop</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å Report ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>
        <li>‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢ <b>History</b> ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ <b>Export</b></li>
      </ol>

      <div class="onBtns">
        <button type="button" id="okOnBtn">Got it</button>
      </div>
    </div>
  </div>

<script>
/* =========================
  STORAGE KEYS (v0.5.3)
========================= */
const KEY_STATE   = "qps_timer_state_v4";
const KEY_DATA    = "qpsData_v4";
const KEY_STREAK  = "qps_streak_v2";
const KEY_UNDO    = "qps_undo_v2";
const KEY_ONBOARD = "qps_onboard_seen_v2";

/* Morning Gate */
const KEY_GATE      = "qps_morning_gate_v3";        // day/runtime state
const KEY_GATE_CFG  = "qps_morning_gate_cfg_v1";    // trigger + lock 7 days
const KEY_GATE_PREF_LEGACY = "qps_gate_pref_v1";    // legacy (optional migrate)

/* =========================
  RULES
========================= */
const RULES = {
  basePerMinute: 0.4,
  bonusMinMinutes: 30,
  baseCapPerQuestNamePerDay: 60,
};

const GATE_RULES = {
  limitMin: 10,         // FIX
  qualifyMin: 3,        // FIX
  bonusPoints: 6,
  lockDays: 7
};

/* =========================
  UTIL
========================= */
function localDateKey(d = new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDays(dateKey, delta){
  const [y,m,d] = dateKey.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate() + delta);
  return localDateKey(dt);
}
function formatHMS(ms){
  const s=Math.max(0,Math.floor(ms/1000));
  const hh=String(Math.floor(s/3600)).padStart(2,"0");
  const mm=String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function formatMMSS(sec){
  const s = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function round1(n){ return Math.round(n*10)/10; }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function scrollToId(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({ behavior:"smooth", block:"start" });
}
function normQuestName(name){
  return (name || "").trim().replace(/\s+/g," ");
}
function sanitizeDigitsOnly(v){ return String(v ?? "").replace(/[^\d]/g,""); }
function parseHHMM(s){
  const m = String(s||"").match(/^(\d{2}):(\d{2})$/);
  if(!m) return null;
  const hh = Number(m[1]), mm = Number(m[2]);
  if(!Number.isFinite(hh)||!Number.isFinite(mm)) return null;
  if(hh<0||hh>23||mm<0||mm>59) return null;
  return { hh, mm };
}
function todayAtHHMM(triggerStr){
  const t = parseHHMM(triggerStr);
  const now = new Date();
  if(!t) return null;
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), t.hh, t.mm, 0, 0);
}
function msToHuman(ms){
  ms = Math.max(0, ms|0);
  const totalMin = Math.ceil(ms/60000);
  const d = Math.floor(totalMin / (60*24));
  const h = Math.floor((totalMin - d*60*24) / 60);
  const m = totalMin - d*60*24 - h*60;
  if(d>0) return `${d}d ${h}h`;
  if(h>0) return `${h}h ${m}m`;
  return `${m}m`;
}

/* =========================
  DATA LAYER
========================= */
function loadAll(){
  try { return JSON.parse(localStorage.getItem(KEY_DATA)) || {}; }
  catch { return {}; }
}
function saveAll(data){
  localStorage.setItem(KEY_DATA, JSON.stringify(data));
}
function ensureDay(data, dateKey){
  if(!data[dateKey]) data[dateKey] = { totalQps: 0, quests: [] };
  if(!Array.isArray(data[dateKey].quests)) data[dateKey].quests = [];
  if(typeof data[dateKey].totalQps !== "number") data[dateKey].totalQps = 0;
  return data[dateKey];
}
function recalcDayTotal(dayObj){
  const total = (dayObj.quests||[]).reduce((s,q)=> s + (Number(q.questScore)||0), 0);
  dayObj.totalQps = round1(total);
}
function listDays(){
  const data = loadAll();
  return Object.keys(data).sort().reverse();
}
function calcDayTotal(dateKey){
  const data = loadAll();
  const day = data[dateKey];
  if(!day) return 0;
  return round1(typeof day.totalQps === "number"
    ? day.totalQps
    : (day.quests||[]).reduce((s,q)=> s + (Number(q.questScore)||0), 0)
  );
}
function calcQuestBaseMinutesUsed(dateKey, questName){
  const data = loadAll();
  const day = data[dateKey];
  if(!day || !Array.isArray(day.quests)) return 0;
  const qn = normQuestName(questName).toLowerCase();
  return day.quests
    .filter(x => (normQuestName(x.questName).toLowerCase() === qn))
    .reduce((s,x) => s + (Number(x.baseMinutesUsed)||0), 0);
}
function isQuestNameDuplicateToday(dateKey, questName){
  const data = loadAll();
  const day = data[dateKey];
  if(!day || !Array.isArray(day.quests)) return false;
  const qn = normQuestName(questName).toLowerCase();
  return day.quests.some(x => normQuestName(x.questName).toLowerCase() === qn);
}
function isDayDone(dateKey){
  const data = loadAll();
  const day = data[dateKey];
  return !!(day && Array.isArray(day.quests) && day.quests.length > 0);
}
function isFirstQuestAlreadyDoneToday(){
  return isDayDone(localDateKey());
}

/* =========================
  STREAK
========================= */
function loadStreak(){
  const raw = localStorage.getItem(KEY_STREAK);
  try { return raw ? JSON.parse(raw) : { current:0, best:0, lastDone:null }; }
  catch { return { current:0, best:0, lastDone:null }; }
}
function saveStreak(s){ localStorage.setItem(KEY_STREAK, JSON.stringify(s)); }
function computeStreakFromLogs(){
  const today = localDateKey();
  if(!isDayDone(today)) return { current:0 };

  let current = 0;
  let cursor = today;
  while(isDayDone(cursor)){
    current++;
    cursor = addDays(cursor, -1);
  }
  return { current };
}
function updateStreakAfterChange(){
  const s = loadStreak();
  const computed = computeStreakFromLogs();
  s.current = computed.current;
  if(s.current > (s.best || 0)) s.best = s.current;
  s.lastDone = isDayDone(localDateKey()) ? localDateKey() : s.lastDone;
  saveStreak(s);
  renderStreak();
}
function renderStreak(){
  const s = loadStreak();
  el.streakPill.innerHTML = `üî• Streak: <b>${s.current}</b> ‚Ä¢ Best: <b>${s.best}</b>`;
}

/* =========================
  UNDO/REDO
========================= */
function loadUndo(){
  try { return JSON.parse(localStorage.getItem(KEY_UNDO)) || { undo: null, redo: null }; }
  catch { return { undo:null, redo:null }; }
}
function saveUndo(u){ localStorage.setItem(KEY_UNDO, JSON.stringify(u)); }
function snapshotData(){ return loadAll(); }
function applySnapshot(snap){
  if(!snap || typeof snap !== "object") return;
  saveAll(snap);
  updateStreakAfterChange();
  updateUI();
  if(el.overlay.classList.contains("show")){
    renderHistoryDays();
    renderDayView(selectedDay || localDateKey());
  }
}
function pushUndoSnapshot(){
  const u = loadUndo();
  u.undo = snapshotData();
  u.redo = null;
  saveUndo(u);
  renderUndoRedo();
}
function renderUndoRedo(){
  const u = loadUndo();
  el.undoBtn.disabled = !u.undo;
  el.redoBtn.disabled = !u.redo;
}
function doUndo(){
  const u = loadUndo();
  if(!u.undo) return;
  u.redo = snapshotData();
  const back = u.undo;
  u.undo = null;
  saveUndo(u);
  applySnapshot(back);
  renderUndoRedo();
}
function doRedo(){
  const u = loadUndo();
  if(!u.redo) return;
  u.undo = snapshotData();
  const fwd = u.redo;
  u.redo = null;
  saveUndo(u);
  applySnapshot(fwd);
  renderUndoRedo();
}

/* =========================
  ELEMENTS
========================= */
const el = {
  appScroll: document.getElementById("appScroll"),

  todayText: document.getElementById("todayText"),
  statusPill: document.getElementById("statusPill"),
  streakPill: document.getElementById("streakPill"),

  gateToggleBtn: document.getElementById("gateToggleBtn"),
  gateSettingsBox: document.getElementById("gateSettingsBox"),
  gateTriggerTimeInput: document.getElementById("gateTriggerTimeInput"),
  gateTriggerHint: document.getElementById("gateTriggerHint"),

  category: document.getElementById("category"),
  questName: document.getElementById("questName"),
  nameWarn: document.getElementById("nameWarn"),

  timerText: document.getElementById("timerText"),
  timerHint: document.getElementById("timerHint"),
  timerWarn: document.getElementById("timerWarn"),

  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  pauseBtn: document.getElementById("pauseBtn"),
  resumeBtn: document.getElementById("resumeBtn"),

  reportCard: document.getElementById("reportCard"),
  reportMinutes: document.getElementById("reportMinutes"),
  qualityBonus: document.getElementById("qualityBonus"),
  notes: document.getElementById("notes"),
  bonusRuleHint: document.getElementById("bonusRuleHint"),
  capHint: document.getElementById("capHint"),
  submitReportBtn: document.getElementById("submitReportBtn"),
  discardBtn: document.getElementById("discardBtn"),
  submitOk: document.getElementById("submitOk"),
  submitWarn: document.getElementById("submitWarn"),

  todayTotal: document.getElementById("todayTotal"),
  progressFill: document.getElementById("progressFill"),
  todayList: document.getElementById("todayList"),

  historyBtn: document.getElementById("historyBtn"),
  resetTodayBtn: document.getElementById("resetTodayBtn"),
  undoBtn: document.getElementById("undoBtn"),
  redoBtn: document.getElementById("redoBtn"),

  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  importFile: document.getElementById("importFile"),

  overlay: document.getElementById("overlay"),
  closeOverlayBtn: document.getElementById("closeOverlayBtn"),
  dayList: document.getElementById("dayList"),
  dayView: document.getElementById("dayView"),
  histTitle: document.getElementById("histTitle"),

  tooltip: document.getElementById("tooltip"),
  tipArrow: document.getElementById("tipArrow"),
  tipTitle: document.getElementById("tipTitle"),
  tipBody: document.getElementById("tipBody"),
  tipCloseBtn: document.getElementById("tipCloseBtn"),

  onOverlay: document.getElementById("onOverlay"),
  openOnboardBtn: document.getElementById("openOnboardBtn"),
  okOnBtn: document.getElementById("okOnBtn"),

  cutWrap: document.getElementById("cutWrap"),
  cutToggleBtn: document.getElementById("cutToggleBtn"),
  cutBody: document.getElementById("cutBody"),
  cutChip: document.getElementById("cutChip"),
  cutMinutes: document.getElementById("cutMinutes"),
  cutMode: document.getElementById("cutMode"),

  gateCover: document.getElementById("gateCover"),
  gateCoverStatusChip: document.getElementById("gateCoverStatusChip"),
  gateCoverTime: document.getElementById("gateCoverTime"),
  gateCoverHint: document.getElementById("gateCoverHint"),
  gateCoverKicker: document.getElementById("gateCoverKicker"),
  gateCoverStartBtn: document.getElementById("gateCoverStartBtn"),
  gateTriggerDisplay: document.getElementById("gateTriggerDisplay"),
  gateLimitDisplay: document.getElementById("gateLimitDisplay"),
  gateQualifyDisplay: document.getElementById("gateQualifyDisplay"),

  gateTopBar: document.getElementById("gateTopBar"),
  gateTopTitle: document.getElementById("gateTopTitle"),
  gateTopSub: document.getElementById("gateTopSub"),
  gateTopTime: document.getElementById("gateTopTime"),
  gateTopOpenBtn: document.getElementById("gateTopOpenBtn"),
};

/* =========================
  STATE (timer)
========================= */
let state = {
  status: "idle", // idle|running|paused|stopped
  startTs: null,
  elapsedBefore: 0,
  lastElapsedMs: 0,
  startDateKey: null,

  selectedCategory: "Learning",
  questName: "",

  cutEnabled: false,
  cutMinutes: null,
  cutMode: "hard",

  softWarned: false,
  softDeadlineTs: 0,
};
let tickHandle = null;

function saveState(){ localStorage.setItem(KEY_STATE, JSON.stringify(state)); }
function loadState(){
  const raw = localStorage.getItem(KEY_STATE);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(s && typeof s==="object") state = { ...state, ...s };
  }catch{}
}

/* =========================
  MORNING GATE CONFIG (v4: lock 7 days)
========================= */
let gateCfg = {
  enabled: false,
  triggerHHMM: null,
  lockedUntil: 0,
  effectiveFrom: null
};

function loadGateCfg(){
  gateCfg = { enabled:false, triggerHHMM:null, lockedUntil:0, effectiveFrom:null };

  // migrate legacy if present
  try{
    const legacyRaw = localStorage.getItem(KEY_GATE_PREF_LEGACY);
    if(legacyRaw){
      const p = JSON.parse(legacyRaw);
      if(p && typeof p==="object" && /^\d{2}:\d{2}$/.test(p.triggerHHMM)){
        const last = Number(p.lastChangedAt || 0);
        const lockedUntil = last ? (last + GATE_RULES.lockDays*24*60*60*1000) : 0;
        gateCfg.triggerHHMM = p.triggerHHMM;
        gateCfg.enabled = !!p.enabled;
        gateCfg.lockedUntil = lockedUntil;
        gateCfg.effectiveFrom = localDateKey();
      }
    }
  }catch{}

  // load new cfg (overrides)
  try{
    const raw = localStorage.getItem(KEY_GATE_CFG);
    if(raw){
      const c = JSON.parse(raw);
      if(c && typeof c==="object"){
        gateCfg.enabled = (typeof c.enabled === "boolean") ? c.enabled : gateCfg.enabled;
        gateCfg.triggerHHMM = /^\d{2}:\d{2}$/.test(c.triggerHHMM||"") ? c.triggerHHMM : gateCfg.triggerHHMM;
        gateCfg.lockedUntil = Number.isFinite(Number(c.lockedUntil)) ? Number(c.lockedUntil) : gateCfg.lockedUntil;
        gateCfg.effectiveFrom = /^\d{4}-\d{2}-\d{2}$/.test(c.effectiveFrom||"") ? c.effectiveFrom : gateCfg.effectiveFrom;
      }
    }
  }catch{}

  // sanitize
  if(gateCfg.triggerHHMM && !parseHHMM(gateCfg.triggerHHMM)) gateCfg.triggerHHMM = null;
  if(!Number.isFinite(gateCfg.lockedUntil)) gateCfg.lockedUntil = 0;
  if(gateCfg.effectiveFrom && !/^\d{4}-\d{2}-\d{2}$/.test(gateCfg.effectiveFrom)) gateCfg.effectiveFrom = null;

  // if not set trigger -> must be OFF (‡∏Å‡∏±‡∏ô ‚Äú‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‚Äù)
  if(!gateCfg.triggerHHMM){
    gateCfg.enabled = false;
    gateCfg.effectiveFrom = null;
    gateCfg.lockedUntil = 0;
  }

  saveGateCfg(); // normalize
}
function saveGateCfg(){
  localStorage.setItem(KEY_GATE_CFG, JSON.stringify(gateCfg));
}
function canEditTriggerNow(){
  if(!gateCfg.triggerHHMM) return true;
  return Date.now() >= (gateCfg.lockedUntil || 0);
}
function computeEffectiveFromForSetting(hhmm){
  const t = todayAtHHMM(hhmm);
  if(!t) return localDateKey();
  const now = new Date();
  if(now > t) return addDays(localDateKey(), 1); // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á trigger ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏µ‡∏ú‡∏•
  return localDateKey();
}
function setTriggerWithLock7Days(hhmm){
  if(!parseHHMM(hhmm)) return { ok:false, msg:"‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô HH:MM" };
  if(!canEditTriggerNow()) return { ok:false, msg:"Locked ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 7 ‡∏ß‡∏±‡∏ô" };

  const eff = computeEffectiveFromForSetting(hhmm);
  gateCfg.triggerHHMM = hhmm;
  gateCfg.lockedUntil = Date.now() + GATE_RULES.lockDays*24*60*60*1000;
  gateCfg.effectiveFrom = eff;

  saveGateCfg();
  return { ok:true, effectiveFrom: eff };
}
function isGateActiveToday(){
  if(!gateCfg.enabled) return false;
  if(!gateCfg.triggerHHMM) return false;
  if(!gateCfg.effectiveFrom) return false;
  return localDateKey() >= gateCfg.effectiveFrom;
}
function todayTriggerTs(){
  if(!isGateActiveToday()) return 0;
  const t = todayAtHHMM(gateCfg.triggerHHMM);
  return t ? t.getTime() : 0;
}
function todayDeadlineTs(){
  const trig = todayTriggerTs();
  if(!trig) return 0;
  return trig + GATE_RULES.limitMin * 60000;
}

/* =========================
  MORNING GATE runtime (day state)
========================= */
let gate = {
  dateKey: null,

  enabled: false,
  triggerHHMM: null,

  startedAt: 0,
  locked: false,
  unlocked: false,
  unlockReason: "",
  passed: false,

  firstQuestStartAt: 0,
  bonusGranted: false,

  doneBannerUntil: 0
};

function saveGate(){ localStorage.setItem(KEY_GATE, JSON.stringify(gate)); }
function gateResetForToday(force=false){
  const today = localDateKey();
  gate.dateKey = today;

  gate.startedAt = 0;
  gate.locked = false;
  gate.unlocked = false;
  gate.unlockReason = "";
  gate.passed = false;
  gate.firstQuestStartAt = 0;
  gate.bonusGranted = false;
  gate.doneBannerUntil = 0;

  if(force) saveGate();
}
function loadGate(){
  try{
    const raw = localStorage.getItem(KEY_GATE);
    if(raw){
      const g = JSON.parse(raw);
      if(g && typeof g==="object") gate = { ...gate, ...g };
    }
  }catch{}

  const today = localDateKey();
  if(gate.dateKey !== today){
    gateResetForToday(true);
  }

  if(isFirstQuestAlreadyDoneToday()){
    gate.passed = true;
    gate.locked = false;
    gate.unlocked = true;
    saveGate();
  }
}
function syncGateRuntimeFromCfg(){
  gate.enabled = isGateActiveToday();
  gate.triggerHHMM = gateCfg.triggerHHMM || null;

  // ‡∏ñ‡πâ‡∏≤ OFF ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà active ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if(!gate.enabled){
    gate.startedAt = 0;
    gate.locked = false;
    gate.unlocked = true;
    gate.passed = isFirstQuestAlreadyDoneToday() ? true : false;
    saveGate();
  }
}
function gateWorldStartTs(){ return todayTriggerTs() || 0; }
function gateWorldDeadlineTs(){ return todayDeadlineTs() || 0; }

function gateIsWorldActiveNow(){
  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞: ON + active today + ‡∏´‡∏•‡∏±‡∏á trigger + ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å
  if(!isGateActiveToday()) return false;
  if(isFirstQuestAlreadyDoneToday() || gate.passed) return false;
  const now = Date.now();
  const start = gateWorldStartTs();
  if(!start) return false;
  return now >= start;
}
function gateTimeLeftSec(){
  if(!gate.startedAt) return 0;
  const end = gate.startedAt + GATE_RULES.limitMin * 60000;
  const ms = end - Date.now();
  return Math.max(0, Math.ceil(ms/1000));
}

/* cover/topbar show/hide */
function showGateCover(){
  el.gateCover.classList.add("show");
  document.body.style.overflow = "hidden";
  el.gateCover.setAttribute("aria-hidden","false");
}
function hideGateCover(){
  el.gateCover.classList.remove("show");
  document.body.style.overflow = "";
  el.gateCover.setAttribute("aria-hidden","true");
}
function showGateTopBar(){
  el.gateTopBar.classList.add("show");
  document.body.classList.add("gateBarOn");
}
function hideGateTopBar(){
  el.gateTopBar.classList.remove("show");
  document.body.classList.remove("gateBarOn");
  el.gateTopBar.classList.remove("done");
}

function gateMaybeLock(){
  if(!isGateActiveToday()) return;
  if(gate.passed || isFirstQuestAlreadyDoneToday()) return;
  if(!gateIsWorldActiveNow()) return;

  const now = Date.now();
  const deadline = gateWorldDeadlineTs();

  if(deadline && now > deadline){
    gate.locked = true;
    if(!gate.startedAt) gate.startedAt = gateWorldStartTs();
    saveGate();
    return;
  }

  if(!gate.startedAt) return;
  if(gateTimeLeftSec() <= 0){
    gate.locked = true;
    saveGate();
  }
}

function gateCanStartQuest(){
  if(!isGateActiveToday()) return true;                     // OFF ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà active ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -> ‡∏õ‡∏•‡πà‡∏≠‡∏¢
  if(gate.passed || isFirstQuestAlreadyDoneToday()) return true;
  if(!gateIsWorldActiveNow()) return true;                  // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á trigger -> ‡∏õ‡∏•‡πà‡∏≠‡∏¢
  if(!gate.startedAt) return false;                         // ‡∏ñ‡∏∂‡∏á trigger ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° gate -> ‡∏ö‡∏•‡πá‡∏≠‡∏Å
  if(gate.locked && !gate.unlocked) return false;           // lock -> ‡∏ö‡∏•‡πá‡∏≠‡∏Å
  return true;
}

function gateEnforceStartButton(){
  if(state.status !== "idle"){
    el.startBtn.disabled = true;
    return;
  }
  el.startBtn.disabled = !gateCanStartQuest();
}

function gateStartFromCover(){
  if(!isGateActiveToday()){
    hideGateCover();
    hideGateTopBar();
    return;
  }
  if(isFirstQuestAlreadyDoneToday()){
    gate.passed = true;
    gate.unlocked = true;
    gate.locked = false;
    saveGate();
    hideGateCover();
    hideGateTopBar();
    return;
  }

  gate.startedAt = Date.now();
  gate.locked = false;
  gate.unlocked = false;
  gate.unlockReason = "";
  gate.passed = false;
  gate.firstQuestStartAt = 0;
  gate.doneBannerUntil = 0;
  saveGate();

  hideGateCover();
  showGateTopBar();
}

function gateConsumeReasonIfAny(){
  if(!gate.unlockReason) return "";
  const msg = `Morning Gate Unlock: ${gate.unlockReason}`;
  gate.unlockReason = "";
  saveGate();
  return msg;
}

function gateGrantBonusIfEligible(){
  if(!isGateActiveToday()) return;
  if(gate.bonusGranted) return;
  if(!gate.passed) return;

  const now = Date.now();
  const deadline = gateWorldDeadlineTs();
  if(!deadline) return;

  const withinDeadline = now <= deadline;
  const blockedByUnlock = gate.unlocked === true;
  if(!withinDeadline) return;
  if(blockedByUnlock) return;

  const todayKey = localDateKey();
  const data = loadAll();
  const day = ensureDay(data, todayKey);

  const bonusName = "Morning Gate Bonus";
  const exists = day.quests.some(q => normQuestName(q.questName).toLowerCase() === bonusName.toLowerCase());
  if(exists){
    gate.bonusGranted = true;
    saveGate();
    return;
  }

  pushUndoSnapshot();

  const entry = {
    ts: Date.now(),
    dateKey: todayKey,
    category: "Connection",
    questName: bonusName,
    minutesSpent: 0,
    baseMinutesUsed: 0,
    baseScore: 0,
    qualityBonus: GATE_RULES.bonusPoints,
    questScore: GATE_RULES.bonusPoints,
    notes: `Auto Bonus: PASS within deadline ‚Ä¢ Trigger ${gateCfg.triggerHHMM} ‚Ä¢ Limit ${GATE_RULES.limitMin}m`
  };

  day.quests.push(entry);
  recalcDayTotal(day);
  saveAll(data);

  gate.bonusGranted = true;
  saveGate();

  updateStreakAfterChange();
  updateUI();
}

function gateCheckFirstQuestQualify(){
  if(!isGateActiveToday()) return;
  if(gate.passed) return;
  if(!gate.firstQuestStartAt) return;
  if(state.status !== "running") return;

  const ms = computeElapsedMs();
  if(ms >= GATE_RULES.qualifyMin * 60000){
    gate.passed = true;
    gate.locked = false;
    gate.unlocked = false; // unlock = ‡∏ú‡∏¥‡∏î‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤
    gate.doneBannerUntil = Date.now() + 2000;
    saveGate();
    gateGrantBonusIfEligible();
  }
}

function renderGateCoverDisplay(){
  el.gateTriggerDisplay.textContent = (gateCfg.triggerHHMM ? gateCfg.triggerHHMM : "--.--");
  el.gateLimitDisplay.textContent = `${GATE_RULES.limitMin}m`;
  el.gateQualifyDisplay.textContent = `${GATE_RULES.qualifyMin}m`;
}

/* ‚úÖ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: ‡∏Å‡∏≤‡∏£‡πå‡∏î settings ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô ON */
function renderGateSettingsUI(){
  el.gateSettingsBox.style.display = gateCfg.enabled ? "block" : "none";

  // ‡∏ñ‡πâ‡∏≤ OFF ‡∏Å‡πá‡∏à‡∏ö
  if(!gateCfg.enabled) return;

  el.gateTriggerTimeInput.value = gateCfg.triggerHHMM || "";

  if(!gateCfg.triggerHHMM){
    el.gateTriggerHint.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á Trigger ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô --.-- ‡πÅ‡∏•‡∏∞ Gate ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
    return;
  }

  if(canEditTriggerNow()){
    el.gateTriggerHint.textContent = `‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å ${GATE_RULES.lockDays} ‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á)`;
  }else{
    const ms = (gateCfg.lockedUntil || 0) - Date.now();
    el.gateTriggerHint.textContent = `Locked ‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ${msToHuman(ms)}`;
  }

  if(gateCfg.effectiveFrom && localDateKey() < gateCfg.effectiveFrom){
    el.gateTriggerHint.textContent += ` ‚Ä¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ ${gateCfg.effectiveFrom}`;
  }
}

function renderGateTogglePill(){
  // pill = intent (enabled)
  const canOn = !!gateCfg.triggerHHMM;
  const on = gateCfg.enabled && canOn;

  el.gateToggleBtn.textContent = on ? "ON" : "OFF";
  el.gateToggleBtn.classList.toggle("on", on);

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á trigger -> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô OFF
  if(!canOn){
    el.gateToggleBtn.textContent = "OFF";
    el.gateToggleBtn.classList.remove("on");
  }
}

function renderGateUX(){
  renderGateCoverDisplay();

  // ‚úÖ ‡∏ñ‡πâ‡∏≤ OFF ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà active ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏î‡πâ‡∏á
  if(!gateCfg.enabled || !gateCfg.triggerHHMM || !isGateActiveToday()){
    hideGateCover();
    hideGateTopBar();

    el.gateCoverStatusChip.textContent = (!gateCfg.triggerHHMM ? "STATUS: NOT SET" : "STATUS: OFF");
    el.gateCoverTime.textContent = (!gateCfg.triggerHHMM ? "--.--" : "OFF");
    el.gateCoverHint.innerHTML = (!gateCfg.triggerHHMM)
      ? `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á Trigger ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î ON ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤`
      : `Gate ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà`;
    return;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏•‡πâ‡∏ß = pass
  if(isFirstQuestAlreadyDoneToday() || gate.passed){
    hideGateCover();

    if(gate.doneBannerUntil && Date.now() < gate.doneBannerUntil){
      showGateTopBar();
      el.gateTopBar.classList.add("done");
      el.gateTopTitle.textContent = "Morning Gate ‚Ä¢ DONE ‚úÖ";
      el.gateTopSub.textContent = `‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö ${GATE_RULES.qualifyMin} ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß`;
      el.gateTopTime.textContent = "DONE";
      el.gateTopOpenBtn.textContent = "OK";
    }else{
      hideGateTopBar();
    }

    el.gateCoverStatusChip.textContent = "STATUS: PASS";
    el.gateCoverTime.textContent = "DONE";
    el.gateCoverHint.innerHTML = `PASS ‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    return;
  }

  // ‡∏Å‡πà‡∏≠‡∏ô trigger: ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á
  if(!gateIsWorldActiveNow()){
    hideGateCover();
    hideGateTopBar();

    el.gateCoverStatusChip.textContent = "STATUS: WAIT";
    const start = todayAtHHMM(gateCfg.triggerHHMM);
    if(start){
      const hh = String(start.getHours()).padStart(2,"0");
      const mm = String(start.getMinutes()).padStart(2,"0");
      el.gateCoverTime.textContent = `${hh}:${mm}`;
      el.gateCoverHint.innerHTML = `Gate ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á <b>${gateCfg.triggerHHMM}</b>`;
    }else{
      el.gateCoverTime.textContent = "--:--";
      el.gateCoverHint.innerHTML = `Trigger ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`;
    }
    return;
  }

  // ‡∏ñ‡∏∂‡∏á trigger ‡πÅ‡∏•‡πâ‡∏ß: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° gate -> ‡πÄ‡∏î‡πâ‡∏á cover
  if(!gate.startedAt){
    el.gateCoverStatusChip.textContent = "STATUS: READY";
    el.gateCoverTime.textContent = "--:--";
    el.gateCoverKicker.innerHTML =
      `‡∏ñ‡∏∂‡∏á Trigger ‡πÅ‡∏•‡πâ‡∏ß: <b>${gateCfg.triggerHHMM}</b><br>` +
      `‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° Gate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô`;
    el.gateCoverHint.innerHTML =
      `‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ <b>Start ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å</b> ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤<br>` +
      `PASS ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö <b>${GATE_RULES.qualifyMin} ‡∏ô‡∏≤‡∏ó‡∏µ</b>`;
    showGateCover();
    hideGateTopBar();
    return;
  }

  // ‡∏°‡∏µ startedAt ‡πÅ‡∏•‡πâ‡∏ß -> ‡πÉ‡∏ä‡πâ topbar
  showGateTopBar();
  hideGateCover();
  el.gateTopBar.classList.remove("done");

  // locked
  if(gate.locked && !gate.unlocked){
    el.gateTopTitle.textContent = "Morning Gate ‚Ä¢ LOCKED ‚ùå";
    el.gateTopSub.textContent = "‡∏ï‡πâ‡∏≠‡∏á Unlock ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ Start ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÑ‡∏î‡πâ (‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏∞‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î)";
    el.gateTopTime.textContent = "LOCK";
    el.gateTopOpenBtn.textContent = "Unlock";
    return;
  }

  // unlocked
  if(gate.unlocked){
    el.gateTopTitle.textContent = "Morning Gate ‚Ä¢ Unlocked ‚úÖ";
    el.gateTopSub.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡πÉ‡∏ô Notes)";
    el.gateTopTime.textContent = "OK";
    el.gateTopOpenBtn.textContent = "Gate";
    return;
  }

  // running countdown
  const left = gateTimeLeftSec();
  el.gateTopTime.textContent = formatMMSS(left);
  el.gateTopTitle.textContent = "Morning Gate ‚Ä¢ Running";
  el.gateTopSub.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
  el.gateTopOpenBtn.textContent = "Gate";
}

/* =========================
  UI HELPERS
========================= */
function setReportVisible(v){
  el.reportCard.style.display = v ? "block" : "none";
  document.getElementById("reportHiddenHint").style.display = v ? "none" : "block";
}
function updateStatusPill(){
  const map = {
    idle: "Idle",
    running: "Running",
    paused: "Paused",
    stopped: "Stopped (report pending)",
  };
  el.statusPill.innerHTML = `Status: <b>${map[state.status] || "Idle"}</b>`;
}
function computeElapsedMs(now=Date.now()){
  if(state.status==="running" && state.startTs) return state.elapsedBefore + (now - state.startTs);
  return state.elapsedBefore;
}
function renderTimer(){
  const ms = (state.status==="stopped") ? state.lastElapsedMs : computeElapsedMs();
  el.timerText.textContent = formatHMS(ms);

  if(state.status==="idle") el.timerHint.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start";
  else if(state.status==="running") el.timerHint.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Ä¢ ${state.selectedCategory} ‚Ä¢ ${state.startDateKey}`;
  else if(state.status==="paused") el.timerHint.textContent = "Paused ‚Ä¢ Resume ‡∏´‡∏£‡∏∑‡∏≠ Stop";
  else el.timerHint.textContent = "Stopped ‚Ä¢ ‡∏™‡πà‡∏á Report ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
}
function showTimerWarn(msg){
  el.timerWarn.style.display="block";
  el.timerWarn.textContent=msg;
  setTimeout(()=>{ el.timerWarn.style.display="none"; el.timerWarn.textContent=""; }, 2300);
}
function showNameWarn(msg){
  el.nameWarn.style.display="block";
  el.nameWarn.textContent=msg;
}
function clearNameWarn(){
  el.nameWarn.style.display="none";
  el.nameWarn.textContent="";
}
function clearSubmitMessages(){
  el.submitOk.style.display="none"; el.submitWarn.style.display="none";
  el.submitOk.textContent=""; el.submitWarn.textContent="";
}
function applyBonusRule(minutes){
  if(minutes < RULES.bonusMinMinutes){
    el.qualityBonus.value = "0";
    el.qualityBonus.disabled = true;
    el.bonusRuleHint.textContent = `Bonus lock (‡∏ï‡πâ‡∏≠‡∏á ‚â• ${RULES.bonusMinMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }else{
    el.qualityBonus.disabled = false;
    el.bonusRuleHint.textContent = `Bonus ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÄ‡∏ß‡∏•‡∏≤ ‚â• ${RULES.bonusMinMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }
}
function updateCapHint(dateKey, questName){
  const used = calcQuestBaseMinutesUsed(dateKey, questName);
  const remaining = Math.max(0, RULES.baseCapPerQuestNamePerDay - used);
  el.capHint.textContent =
    `Cap ‡∏ï‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™/‡∏ß‡∏±‡∏ô = ${RULES.baseCapPerQuestNamePerDay} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ "${normQuestName(questName)}" ‡πÉ‡∏ä‡πâ base ‡πÅ‡∏•‡πâ‡∏ß ${used} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining} ‡∏ô‡∏≤‡∏ó‡∏µ`;
}

/* Cutting UI */
function readCutMinutes(){
  const raw = Number(el.cutMinutes.value);
  if(!Number.isFinite(raw)) return null;
  const n = clamp(Math.floor(raw), 1, 360);
  return n;
}
function renderCutUI(){
  el.cutWrap.classList.toggle("open", !!state.cutEnabled);
  el.cutBody.style.display = state.cutEnabled ? "block" : "none";
  if(!state.cutEnabled){
    el.cutChip.textContent = "OFF";
  }else{
    el.cutChip.textContent = state.cutMinutes ? `${state.cutMinutes}m` : "ON";
  }
}

function renderControls(){
  el.stopBtn.disabled   = !(state.status==="running" || state.status==="paused");
  el.pauseBtn.disabled  = state.status !== "running";
  el.resumeBtn.disabled = state.status !== "paused";

  const lock = state.status !== "idle";
  el.category.disabled = lock;
  el.questName.disabled = lock;

  // gate pill only editable when idle
  el.gateToggleBtn.disabled = (state.status !== "idle");

  if(state.status==="idle"){
    el.category.value = state.selectedCategory || "Learning";
    el.questName.value = state.questName || "";
    el.cutMinutes.value = state.cutMinutes ? String(state.cutMinutes) : "";
    el.cutMode.value = state.cutMode || "hard";
  }

  renderCutUI();
  gateEnforceStartButton();
}

function renderToday(){
  const todayKey = localDateKey();
  el.todayText.textContent = `Today: ${todayKey}`;

  const total = calcDayTotal(todayKey);
  el.todayTotal.textContent = total.toFixed(1);
  el.progressFill.style.width = `${Math.max(0,Math.min(100,total))}%`;

  const data = loadAll();
  const day = data[todayKey] || { totalQps:0, quests:[] };
  const log = (day.quests||[]).slice().reverse();

  if(log.length===0){
    el.todayList.innerHTML = `<div class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  el.todayList.innerHTML = log.map(item=>{
    const name = normQuestName(item.questName) ? normQuestName(item.questName) : "(no name)";
    const mins = Number(item.minutesSpent||0);
    const baseMins = Number(item.baseMinutesUsed||0);
    const baseScore = Number(item.baseScore||0);
    const bonus = Number(item.qualityBonus||0);
    const questScore = Number(item.questScore||0);
    const capNote = (baseMins < mins) ? ` ‚Ä¢ cap: counted ${baseMins}/${mins} min` : "";
    return `
      <div class="item">
        <div class="itemTop">
          <div class="itemName">${escapeHtml(name)}</div>
          <div class="itemScore">+${round1(questScore).toFixed(1)}</div>
        </div>
        <div class="itemMeta">${escapeHtml(item.category)} ‚Ä¢ ${mins} min ‚Ä¢ base ${round1(baseScore).toFixed(1)} + bonus ${bonus}${capNote}</div>
        ${item.notes ? `<div class="itemMeta" style="margin-top:8px;">üìù ${escapeHtml(item.notes)}</div>` : ``}
      </div>
    `;
  }).join("");
}

function updateUI(){
  updateStatusPill();
  renderTimer();
  renderControls();
  renderGateSettingsUI();
  renderGateTogglePill();
  renderToday();
  setReportVisible(state.status==="stopped");
  renderUndoRedo();
}

/* =========================
  TIMER TICK
========================= */
function startTick(){
  if(tickHandle) clearInterval(tickHandle);
  tickHandle = setInterval(()=>{
    renderTimer();

    // auto stop if cutting enabled
    if(state.status === "running" && state.cutEnabled && state.cutMinutes){
      const ms = computeElapsedMs();
      const targetMs = state.cutMinutes * 60000;

      if(ms >= targetMs){
        if(state.cutMode === "soft"){
          if(!state.softWarned){
            state.softWarned = true;
            state.softDeadlineTs = Date.now() + 10000;
            saveState();
            showTimerWarn(`‡∏Ñ‡∏£‡∏ö ${state.cutMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 10 ‡∏ß‡∏¥`);
            return;
          }
          if(Date.now() < state.softDeadlineTs) return;
        }

        state.softWarned = false;
        state.softDeadlineTs = 0;

        state.elapsedBefore = targetMs;
        state.startTs = null;
        saveState();

        showTimerWarn(`Stop ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚úÖ (${state.cutMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`);
        stopQuest();
      }
    }

    // Gate tick
    syncGateRuntimeFromCfg();
    gateMaybeLock();
    gateCheckFirstQuestQualify();
    gateEnforceStartButton();
    renderGateUX();
  }, 250);
}

/* =========================
  ACTIONS
========================= */
function validateBeforeStart(){
  clearNameWarn();
  const todayKey = localDateKey();
  const qn = normQuestName(el.questName.value);

  if(!qn){
    showNameWarn("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Quest Name (‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á)");
    return false;
  }
  if(isQuestNameDuplicateToday(todayKey, qn)){
    showNameWarn("‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚ùå (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥) ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà");
    return false;
  }
  return true;
}

function startQuest(){
  if(state.status !== "idle") return;

  // Gate enforcement
  if(!gateCanStartQuest()){
    showTimerWarn("‡∏ï‡∏¥‡∏î Morning Gate");
    if(isGateActiveToday() && gateIsWorldActiveNow() && !gate.startedAt){
      showGateCover();
      renderGateUX();
    }
    return;
  }

  if(!validateBeforeStart()){
    showTimerWarn("‡πÅ‡∏Å‡πâ Quest Name ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  state.status="running";
  state.selectedCategory = el.category.value;
  state.questName = normQuestName(el.questName.value);
  state.startDateKey = localDateKey();

  state.startTs = Date.now();
  state.elapsedBefore = 0;
  state.lastElapsedMs = 0;

  state.cutMinutes = state.cutEnabled ? readCutMinutes() : null;
  state.cutMode = el.cutMode.value || "hard";
  state.softWarned = false;
  state.softDeadlineTs = 0;

  saveState();
  clearSubmitMessages();
  setReportVisible(false);
  updateUI();

  // Gate qualify tracking: only if active now and first quest today
  if(isGateActiveToday() && gateIsWorldActiveNow() && !gate.passed && !isFirstQuestAlreadyDoneToday()){
    gate.firstQuestStartAt = Date.now();
    saveGate();
  }
}

function pauseQuest(){
  if(state.status!=="running") return;
  const now = Date.now();
  state.elapsedBefore = computeElapsedMs(now);
  state.startTs = null;
  state.status = "paused";
  state.softWarned = false;
  state.softDeadlineTs = 0;
  saveState();
  updateUI();
}

function resumeQuest(){
  if(state.status!=="paused") return;
  state.status="running";
  state.startTs=Date.now();
  state.softWarned = false;
  state.softDeadlineTs = 0;
  saveState();
  updateUI();
}

function stopQuest(){
  if(!(state.status==="running" || state.status==="paused")) return;

  const now = Date.now();
  const elapsed = (state.status==="running") ? computeElapsedMs(now) : state.elapsedBefore;

  state.status="stopped";
  state.startTs=null;
  state.elapsedBefore=elapsed;
  state.lastElapsedMs=elapsed;
  saveState();

  const minutes = Math.max(0, Math.round(elapsed/60000));
  el.reportMinutes.value = String(minutes);
  applyBonusRule(minutes);

  const dateKey = state.startDateKey || localDateKey();
  updateCapHint(dateKey, state.questName);

  clearSubmitMessages();
  setReportVisible(true);
  updateUI();
  scrollToId("sec-report");
}

function discardReport(){
  state.status="idle";
  state.startTs=null;
  state.elapsedBefore=0;
  state.lastElapsedMs=0;
  state.startDateKey=null;

  state.softWarned = false;
  state.softDeadlineTs = 0;

  saveState();
  setReportVisible(false);
  clearSubmitMessages();
  updateUI();
}

function submitReport(){
  clearSubmitMessages();

  const minutes = Number(el.reportMinutes.value);
  if(!Number.isFinite(minutes) || minutes <= 0){
    el.submitWarn.style.display="block";
    el.submitWarn.textContent="Minutes ‡∏ï‡πâ‡∏≠‡∏á > 0";
    return;
  }

  applyBonusRule(minutes);
  const bonus = el.qualityBonus.disabled ? 0 : Number(el.qualityBonus.value||0);

  const dateKey = state.startDateKey || localDateKey();
  const qn = normQuestName(state.questName);

  if(isQuestNameDuplicateToday(dateKey, qn)){
    el.submitWarn.style.display="block";
    el.submitWarn.textContent="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠";
    return;
  }

  const used = calcQuestBaseMinutesUsed(dateKey, qn);
  const remaining = Math.max(0, RULES.baseCapPerQuestNamePerDay - used);
  const baseMinutesUsed = Math.min(minutes, remaining);

  const baseScore = baseMinutesUsed * RULES.basePerMinute;
  const questScore = baseScore + bonus;

  pushUndoSnapshot();

  const entry = {
    ts: Date.now(),
    dateKey,
    category: state.selectedCategory,
    questName: qn,
    minutesSpent: minutes,
    baseMinutesUsed,
    baseScore: round1(baseScore),
    qualityBonus: bonus,
    questScore: round1(questScore),
    notes: (() => {
      const extra = gateConsumeReasonIfAny();
      const base = (el.notes.value || "").trim();
      if(extra && base) return `${extra}\n${base}`;
      if(extra) return extra;
      return base;
    })()
  };

  const data = loadAll();
  const day = ensureDay(data, dateKey);
  day.quests.push(entry);
  recalcDayTotal(day);
  saveAll(data);

  updateStreakAfterChange();

  el.submitOk.style.display="block";
  const capMsg = (baseMinutesUsed < minutes) ? ` (cap: counted ${baseMinutesUsed}/${minutes} min)` : "";
  el.submitOk.textContent = `Saved! +${round1(questScore).toFixed(1)}${capMsg}`;

  el.notes.value = "";
  setTimeout(()=>{ discardReport(); }, 320);
}

function resetToday(){
  const todayKey = localDateKey();
  const ok = confirm(`Reset ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${todayKey})? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î`);
  if(!ok) return;

  pushUndoSnapshot();
  const data = loadAll();
  data[todayKey] = { totalQps:0, quests:[] };
  saveAll(data);

  gateResetForToday(true);
  syncGateRuntimeFromCfg();

  updateStreakAfterChange();
  updateUI();
  showTimerWarn("‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
}

/* =========================
  HISTORY
========================= */
let selectedDay = null;

function openHistory(){
  const days = listDays();
  if(days.length===0){
    showTimerWarn("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á");
    return;
  }
  el.overlay.classList.add("show");
  selectedDay = selectedDay || localDateKey();
  renderHistoryDays();
  renderDayView(selectedDay);
}
function closeHistory(){ el.overlay.classList.remove("show"); }

function renderHistoryDays(){
  const days = listDays();
  const data = loadAll();
  el.dayList.innerHTML = days.map(d=>{
    const t = (data[d]?.totalQps ?? 0);
    const active = (d === selectedDay) ? "active" : "";
    return `<button class="dayBtn ${active}" data-day="${d}">${d} ‚Ä¢ ${Number(t).toFixed(1)} QPS</button>`;
  }).join("");

  el.dayList.querySelectorAll(".dayBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      selectedDay = btn.dataset.day;
      renderHistoryDays();
      renderDayView(selectedDay);
    });
  });
}

function renderDayView(dayKey){
  const data = loadAll();
  const day = data[dayKey] || { totalQps:0, quests:[] };
  el.histTitle.textContent = dayKey;

  if(!day.quests || day.quests.length===0){
    el.dayView.innerHTML = `<div class="hint">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>`;
    return;
  }

  const log = day.quests.slice().reverse();
  el.dayView.innerHTML = `
    <div class="badge" style="margin-bottom:10px;">Total: <b>${Number(day.totalQps||0).toFixed(1)}</b></div>
    <div class="list">
      ${log.map(item=>{
        const name = normQuestName(item.questName) ? normQuestName(item.questName) : "(no name)";
        return `
          <div class="item">
            <div class="itemTop">
              <div class="itemName">${escapeHtml(name)}</div>
              <div class="itemScore">+${Number(item.questScore||0).toFixed(1)}</div>
            </div>
            <div class="itemMeta">
              ${escapeHtml(item.category)} ‚Ä¢ ${item.minutesSpent} min ‚Ä¢ base ${Number(item.baseScore||0).toFixed(1)} + bonus ${item.qualityBonus||0}
            </div>
            ${item.notes ? `<div class="itemMeta" style="margin-top:8px;">üìù ${escapeHtml(item.notes)}</div>` : ``}
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* =========================
  EXPORT/IMPORT
========================= */
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function isValidDataShape(all){
  if(!all || typeof all !== "object") return false;
  for(const dayKey of Object.keys(all)){
    const day = all[dayKey];
    if(!day || typeof day !== "object") return false;
    if(!Array.isArray(day.quests)) return false;
    if(typeof day.totalQps !== "number") return false;
  }
  return true;
}
function exportData(){
  const payload = {
    version: KEY_DATA,
    exportedAt: new Date().toISOString(),
    data: loadAll()
  };
  downloadJson(`qpsData_v4_${localDateKey()}.json`, payload);
  showTimerWarn("Exported ‚úÖ (‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà Downloads)");
}
function importDataObject(imported, mode="merge"){
  const raw = imported?.data ?? imported;
  if(!isValidDataShape(raw)){
    alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á qpsData_v4");
    return;
  }

  pushUndoSnapshot();

  if(mode === "replace"){
    saveAll(raw);
  }else{
    const cur = loadAll();
    for(const dayKey of Object.keys(raw)){
      const incomingDay = raw[dayKey];
      const target = ensureDay(cur, dayKey);
      target.quests = target.quests.concat(incomingDay.quests || []);
      recalcDayTotal(target);
    }
    saveAll(cur);
  }

  updateStreakAfterChange();
  selectedDay = localDateKey();
  updateUI();

  if(el.overlay.classList.contains("show")){
    renderHistoryDays();
    renderDayView(selectedDay);
  }

  if(isFirstQuestAlreadyDoneToday()){
    gate.passed = true;
    gate.locked = false;
    gate.unlocked = true;
    saveGate();
  }

  showTimerWarn(`Imported ‚úÖ (${mode.toUpperCase()})`);
}
async function importFromFile(file){
  const text = await file.text();
  let obj;
  try { obj = JSON.parse(text); }
  catch { alert("‡πÑ‡∏ü‡∏•‡πå JSON ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); return; }

  const choice = prompt("Import mode: ‡∏û‡∏¥‡∏°‡∏û‡πå merge ‡∏´‡∏£‡∏∑‡∏≠ replace", "merge");
  const mode = (choice || "merge").toLowerCase() === "replace" ? "replace" : "merge";
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import ‡πÅ‡∏ö‡∏ö ${mode.toUpperCase()} ?`)) return;

  importDataObject(obj, mode);
}

/* =========================
  TOOLTIP
========================= */
const TIPS = {
  top:   { title: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°", body: "‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: Start ‚Üí Stop ‚Üí Report ‚Üí ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô\nUndo/Redo ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ (‡∏´‡∏ô‡πâ‡∏≤ Today)\nMorning Gate (‡∏ñ‡πâ‡∏≤ ON + ‡∏ï‡∏±‡πâ‡∏á Trigger ‡πÅ‡∏•‡πâ‡∏ß) ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á Trigger Time" },
  timer: { title: "Timer", body: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î + ‡∏ï‡∏±‡πâ‡∏á Quest Name ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start\nPause/Resume ‡πÑ‡∏î‡πâ\nStop ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ Report" },
  name:  { title: "Quest Name (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)", body: "‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß\nCap base ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ô‡∏µ‡πâ (60 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ß‡∏±‡∏ô/‡∏ä‡∏∑‡πà‡∏≠)" },
  today: { title: "Today", body: "‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏ß‡∏™\nExport/Import ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" },
  report:{ title: "Report", body: "Report ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Stop\nMinutes > 0\nBonus ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ‚â• 30 ‡∏ô‡∏≤‡∏ó‡∏µ" },
  cut:   { title: "Cutting Time", body: "‡∏Å‡∏î Set Time ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î\n‡πÉ‡∏™‡πà‡∏ô‡∏≤‡∏ó‡∏µ 1‚Äì360\nHard: ‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ\nSoft: ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 10 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î" },
  gate:  { title: "Morning Gate (‡∏Å‡∏±‡∏ô‡πÇ‡∏Å‡∏á)", body:
`1) ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Trigger = --.-- ‚Üí Gate ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô\n2) Trigger ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å 7 ‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á (‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)\n3) Limit = 10 ‡∏ô‡∏≤‡∏ó‡∏µ (fix) ‚Ä¢ Qualify = 3 ‡∏ô‡∏≤‡∏ó‡∏µ (fix)\n4) ‡∏Å‡∏±‡∏ô‡πÇ‡∏Å‡∏á: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á Trigger ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ\n5) ‡∏ú‡πà‡∏≤‡∏ô = ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÅ‡∏£‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏ö 3 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Üí ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +6` }
};

function showTooltip(anchorEl, tipKey){
  const tip = TIPS[tipKey] || { title:"Tip", body:"-" };
  el.tipTitle.textContent = tip.title;
  el.tipBody.textContent = tip.body;

  const sc = el.appScroll;
  const scRect = sc.getBoundingClientRect();
  const rect = anchorEl.getBoundingClientRect();

  const pad = 10;
  const tw = Math.min(340, scRect.width - 24);

  const anchorLeftInApp = (rect.left - scRect.left) + sc.scrollLeft;
  const anchorTopInApp  = (rect.top  - scRect.top)  + sc.scrollTop;

  let left = anchorLeftInApp;
  let top  = anchorTopInApp + rect.height + pad;

  left = Math.max(sc.scrollLeft + 12, Math.min(left, sc.scrollLeft + scRect.width - tw - 12));

  const approxH = 200;
  if(top + approxH > sc.scrollTop + sc.clientHeight - 12){
    top = anchorTopInApp - approxH - pad;
  }
  top = Math.max(sc.scrollTop + 12, top);

  el.tooltip.style.left = left + "px";
  el.tooltip.style.top  = top + "px";
  el.tooltip.style.width = tw + "px";
  el.tooltip.classList.add("show");

  const arrowSize = 14;
  let ax = anchorLeftInApp + 10;
  ax = Math.max(sc.scrollLeft + 12, Math.min(ax, sc.scrollLeft + scRect.width - arrowSize - 12));
  const ay = (top > anchorTopInApp) ? (anchorTopInApp + rect.height + 2) : (anchorTopInApp - arrowSize - 2);

  el.tipArrow.style.left = ax + "px";
  el.tipArrow.style.top  = ay + "px";
  el.tipArrow.classList.add("show");
}
function hideTooltip(){
  el.tooltip.classList.remove("show");
  el.tipArrow.classList.remove("show");
}

/* =========================
  ONBOARDING
========================= */
function openOnboarding(){ el.onOverlay.classList.add("show"); }
function closeOnboarding(markSeen=true){
  el.onOverlay.classList.remove("show");
  if(markSeen) localStorage.setItem(KEY_ONBOARD, "1");
}
function maybeShowOnboardingFirstTime(){
  const seen = localStorage.getItem(KEY_ONBOARD) === "1";
  if(!seen) openOnboarding();
}

/* =========================
  EVENTS
========================= */
// timer buttons
el.startBtn.addEventListener("click", startQuest);
el.pauseBtn.addEventListener("click", pauseQuest);
el.resumeBtn.addEventListener("click", resumeQuest);
el.stopBtn.addEventListener("click", stopQuest);

// report
el.reportMinutes.addEventListener("input", ()=>{
  const minutes = Number(el.reportMinutes.value);
  if(Number.isFinite(minutes)) applyBonusRule(minutes);
});
el.submitReportBtn.addEventListener("click", submitReport);
el.discardBtn.addEventListener("click", discardReport);

// inputs
el.category.addEventListener("change", ()=>{
  if(state.status==="idle"){
    state.selectedCategory = el.category.value;
    saveState();
  }
});
el.questName.addEventListener("input", ()=>{
  if(state.status==="idle"){
    state.questName = el.questName.value || "";
    saveState();
    clearNameWarn();
  }
});

// history
el.historyBtn.addEventListener("click", openHistory);
el.closeOverlayBtn.addEventListener("click", closeHistory);
el.overlay.addEventListener("click", (e)=>{ if(e.target===el.overlay) closeHistory(); });

// today actions
el.resetTodayBtn.addEventListener("click", resetToday);
el.undoBtn.addEventListener("click", doUndo);
el.redoBtn.addEventListener("click", doRedo);

// export/import
el.exportBtn.addEventListener("click", exportData);
el.importBtn.addEventListener("click", ()=>{
  el.importFile.value = "";
  el.importFile.click();
});
el.importFile.addEventListener("change", async ()=>{
  const file = el.importFile.files?.[0];
  if(!file) return;
  await importFromFile(file);
});

// cutting time
el.cutToggleBtn.addEventListener("click", ()=>{
  if(state.status !== "idle"){
    showTimerWarn("‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô Start ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    return;
  }
  state.cutEnabled = !state.cutEnabled;
  if(!state.cutEnabled){
    state.cutMinutes = null;
    el.cutMinutes.value = "";
    state.softWarned = false;
    state.softDeadlineTs = 0;
  }else{
    state.cutMinutes = readCutMinutes();
  }
  saveState();
  renderCutUI();
});
el.cutMinutes.addEventListener("input", ()=>{
  if(state.status !== "idle") return;
  el.cutMinutes.value = sanitizeDigitsOnly(el.cutMinutes.value);
  state.cutMinutes = readCutMinutes();
  saveState();
  renderCutUI();
});
el.cutMode.addEventListener("change", ()=>{
  if(state.status !== "idle") return;
  state.cutMode = el.cutMode.value || "hard";
  saveState();
});

// tooltip
document.querySelectorAll(".helpBtn[data-tip]").forEach(btn=>{
  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    const key = btn.dataset.tip;
    if(el.tooltip.classList.contains("show")) hideTooltip();
    else showTooltip(btn, key);
  });
});
el.tipCloseBtn.addEventListener("click", hideTooltip);
document.addEventListener("click", (e)=>{
  if(el.tooltip.classList.contains("show")){
    const t = el.tooltip.contains(e.target);
    const hb = e.target.classList && e.target.classList.contains("helpBtn");
    if(!t && !hb) hideTooltip();
  }
});
el.appScroll.addEventListener("scroll", ()=>{ if(el.tooltip.classList.contains("show")) hideTooltip(); }, { passive:true });
window.addEventListener("resize", ()=>{ if(el.tooltip.classList.contains("show")) hideTooltip(); });

// onboarding
el.openOnboardBtn.addEventListener("click", ()=> openOnboarding());
el.okOnBtn.addEventListener("click", ()=> closeOnboarding(true));
el.onOverlay.addEventListener("click", (e)=>{ if(e.target===el.onOverlay) closeOnboarding(true); });

// Gate cover start
el.gateCoverStartBtn.addEventListener("click", gateStartFromCover);

// Gate top button
el.gateTopOpenBtn.addEventListener("click", ()=>{
  if(!isGateActiveToday()) return;

  if(gate.locked && !gate.unlocked){
    const reason = prompt("Unlock Reason (‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏ï‡πà‡∏à‡∏£‡∏¥‡∏á):", "");
    if(reason && reason.trim()){
      gate.unlocked = true;
      gate.locked = false;
      gate.unlockReason = reason.trim();
      gate.bonusGranted = true; // unlock = ‡∏ï‡∏±‡∏î‡πÇ‡∏ö‡∏ô‡∏±‡∏™
      saveGate();
      gateEnforceStartButton();
      renderGateUX();
      showTimerWarn("Unlock ‚úÖ (Bonus ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î)");
    }else{
      showTimerWarn("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô");
    }
    return;
  }

  if(gateIsWorldActiveNow() && !gate.passed){
    const dl = new Date(gateWorldDeadlineTs());
    const pad2 = n => String(n).padStart(2,"0");
    showTimerWarn(`Deadline: ${pad2(dl.getHours())}:${pad2(dl.getMinutes())} ‚Ä¢ PASS ‡∏ó‡∏µ‡πà ${GATE_RULES.qualifyMin} ‡∏ô‡∏≤‡∏ó‡∏µ`);
  }
});

// ‚úÖ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: OFF ‡πÅ‡∏•‡πâ‡∏ß Gate ‡∏´‡∏≤‡∏¢ / ON ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡πâ‡∏á
el.gateToggleBtn.addEventListener("click", ()=>{
  if(state.status !== "idle"){
    showTimerWarn("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Gate ‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô Idle ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    return;
  }

  if(!gateCfg.triggerHHMM){
    showTimerWarn("‡∏ï‡∏±‡πâ‡∏á Trigger ‡∏Å‡πà‡∏≠‡∏ô");
    gateCfg.enabled = false;
    saveGateCfg();
    syncGateRuntimeFromCfg();
    renderGateSettingsUI();
    renderGateTogglePill();
    renderGateUX();
    gateEnforceStartButton();
    return;
  }

  gateCfg.enabled = !gateCfg.enabled;
  saveGateCfg();
  syncGateRuntimeFromCfg();

  // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå overlay ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if(!gateCfg.enabled){
    hideGateCover();
    hideGateTopBar();
  }

  renderGateSettingsUI();
  renderGateTogglePill();
  renderGateUX();
  gateEnforceStartButton();

  showTimerWarn(gateCfg.enabled ? "Morning Gate: ON" : "Morning Gate: OFF");
});

// Gate trigger time change (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô ON + idle)
el.gateTriggerTimeInput.addEventListener("change", ()=>{
  if(state.status !== "idle"){
    showTimerWarn("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô Idle ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    renderGateSettingsUI();
    return;
  }
  if(!gateCfg.enabled){
    // ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏õ‡∏Ñ: OFF ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡πÇ‡∏ú‡∏•‡πà ‡πÅ‡∏ï‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ
    showTimerWarn("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î ON ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ");
    renderGateSettingsUI();
    return;
  }

  const hhmm = el.gateTriggerTimeInput.value;
  if(!hhmm){
    showTimerWarn("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤");
    renderGateSettingsUI();
    return;
  }

  const res = setTriggerWithLock7Days(hhmm);
  if(!res.ok){
    showTimerWarn(res.msg);
    renderGateSettingsUI();
    return;
  }

  // reset daily runtime ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
  gateResetForToday(true);
  syncGateRuntimeFromCfg();

  renderGateSettingsUI();
  renderGateTogglePill();
  renderGateUX();
  gateEnforceStartButton();

  if(res.effectiveFrom && localDateKey() < res.effectiveFrom){
    showTimerWarn(`Trigger set ‚Üí ${gateCfg.triggerHHMM} (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ)`);
  }else{
    showTimerWarn(`Trigger set ‚Üí ${gateCfg.triggerHHMM}`);
  }
});

/* =========================
  BACKGROUND FIX
========================= */
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    syncGateRuntimeFromCfg();
    gateMaybeLock();
    gateCheckFirstQuestQualify();
    gateEnforceStartButton();
    renderGateUX();
  }
});
window.addEventListener("focus", ()=>{
  syncGateRuntimeFromCfg();
  gateMaybeLock();
  gateCheckFirstQuestQualify();
  gateEnforceStartButton();
  renderGateUX();
});

/* =========================
  BOOT
========================= */
function boot(){
  loadState();
  loadGateCfg();
  loadGate();
  syncGateRuntimeFromCfg();

  // restore running safety
  if(state.status==="running" && !state.startTs){
    state.status="paused";
    state.startTs=null;
    saveState();
  }

  if(state.status==="idle"){
    el.category.value = state.selectedCategory || "Learning";
    el.questName.value = state.questName || "";
    el.cutMinutes.value = state.cutMinutes ? String(state.cutMinutes) : "";
    el.cutMode.value = state.cutMode || "hard";
  }

  renderCutUI();
  updateUI();
  updateStreakAfterChange();
  maybeShowOnboardingFirstTime();

  renderGateSettingsUI();
  renderGateTogglePill();
  renderGateUX();
  gateEnforceStartButton();

  startTick();
}
boot();
</script>
</body>
</html>