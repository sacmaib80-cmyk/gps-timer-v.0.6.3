<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QPS Timer v0.3 (Cute + Compact)</title>

  <style>
/* =========================================================
  [BOX 0] THEME
========================================================= */
:root{
  --bg: #f6f9ff;
  --bg2:#eef7ff;

  --card:#ffffff;
  --ink:#0f172a;
  --muted:#64748b;

  --accent:#22c55e;      /* green */
  --accent2:#60a5fa;     /* soft blue */
  --warn:#fb7185;        /* pink-red */
  --gold:#f59e0b;

  --border: rgba(15,23,42,.10);
  --shadow: 0 10px 24px rgba(2,6,23,.10);

  --r: 16px;
  --r2: 22px;
}

/* reset */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1100px 700px at 12% 8%, rgba(96,165,250,.22), transparent 55%),
    radial-gradient(1000px 700px at 86% 18%, rgba(34,197,94,.18), transparent 52%),
    radial-gradient(900px 700px at 48% 92%, rgba(245,158,11,.12), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
  overflow:hidden;
}

/* =========================================================
  [BOX 1] APP LAYOUT
========================================================= */
.app{
  height:100vh;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px 12px 42px;
}
.container{
  max-width: 920px;
  margin: 0 auto;
}

/* sticky topbar */
.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  margin: 0 auto 10px;
  padding: 10px 10px 12px;
  background: linear-gradient(180deg, rgba(246,249,255,.98), rgba(246,249,255,.82), rgba(246,249,255,.00));
  backdrop-filter: blur(10px);
}
.topbarRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.brand h1{
  margin:0;
  font-size: 16px;
  line-height:1.2;
  letter-spacing:.2px;
}
.brand .sub{
  margin:6px 0 0;
  color:var(--muted);
  font-size:12px;
}

/* pills on right */
.pills{
  display:flex;
  gap:8px;
  align-items:flex-start;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 7px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.92);
  border: 1px solid var(--border);
  box-shadow: 0 6px 14px rgba(2,6,23,.06);
  font-size:12px;
  color:var(--muted);
  white-space: nowrap;
}
.pill b{ color:var(--ink); }
.streakPill{ color: var(--ink); }
.streakPill .fire{
  filter: drop-shadow(0 6px 10px rgba(245,158,11,.22));
}

/* compact jump tabs */
.jump{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}
.jump button{
  padding: 8px 10px;
  border-radius: 999px;
  font-size: 12px;
}

/* sections */
.section{
  margin-top: 10px;
  scroll-margin-top: 110px;
}
.sectionHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin: 6px 2px 10px;
}
.sectionHead h2{
  margin:0;
  font-size: 12px;
  color: var(--muted);
  letter-spacing:.2px;
  font-weight: 800;
}

/* cards */
.card{
  background: rgba(255,255,255,.94);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  box-shadow: var(--shadow);
  padding: 14px;
}
.divider{
  height:1px;
  background: var(--border);
  margin: 12px 0;
}

/* form grid */
.row{
  display:grid;
  gap:10px;
  grid-template-columns: 1fr;
}
@media(min-width:720px){
  .row.two{ grid-template-columns: 1fr 1fr; }
}

/* inputs */
label{
  display:block;
  color:var(--muted);
  font-size: 12px;
  margin-bottom: 6px;
}
input,select,textarea{
  width:100%;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: white;
  color: var(--ink);
  padding: 11px 12px;
  outline:none;
  font-size: 14px;
}
textarea{ min-height: 92px; resize: vertical; }

/* =========================================================
  [BOX 2] BUTTONS (compact)
========================================================= */
button{
  border:0;
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 14px;
  font-weight: 800;
  cursor:pointer;
  color: white;
  background: linear-gradient(180deg, var(--accent), #16a34a);
  box-shadow: 0 10px 18px rgba(34,197,94,.18);
}
button.secondary{
  color: var(--ink);
  background: rgba(2,6,23,.05);
  border: 1px solid var(--border);
  box-shadow:none;
}
button.danger{
  color: #7f1d1d;
  background: rgba(251,113,133,.20);
  border: 1px solid rgba(251,113,133,.30);
  box-shadow:none;
}
button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

/* timer layout */
.timerRow{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.timer{
  font-variant-numeric: tabular-nums;
  font-size: 44px;
  letter-spacing: 1px;
  margin: 6px 0 2px;
}
.hint{ color: var(--muted); font-size:12px; margin-top:6px; line-height:1.45; }
.ok{ color:#15803d; font-size:12px; margin-top:8px; }
.warn{ color:#be123c; font-size:12px; margin-top:8px; }
.miniWarn{
  display:none;
  margin-top:8px;
  padding: 8px 10px;
  border-radius: 14px;
  background: rgba(251,113,133,.14);
  border: 1px solid rgba(251,113,133,.22);
  color:#9f1239;
  font-size: 12px;
  font-weight: 800;
}

/* action bar: 1 big + 3 small pills */
.actionBar{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top: 12px;
}
.actionBar .primary{
  flex: 1 1 220px;
  min-width: 200px;
}
.pillBtns{
  display:flex;
  gap:8px;
  flex: 0 0 auto;
}
.pillBtns button{
  padding: 9px 10px;
  border-radius: 999px;
  font-size: 13px;
  box-shadow:none;
}
.pillBtns button.secondary{ background: rgba(2,6,23,.05); }
.pillBtns button.danger{ background: rgba(251,113,133,.18); }

/* progress */
.progressWrap{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.86);
  color: var(--muted);
  font-size: 12px;
  white-space: nowrap;
}
.badge b{ color: var(--ink); }
.bar{
  margin-top:12px;
  background: rgba(2,6,23,.06);
  border: 1px solid var(--border);
  border-radius: 999px;
  overflow:hidden;
  height: 12px;
}
.bar > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  transition: width 240ms ease;
}

/* list */
.list{
  display:grid;
  gap:10px;
  margin-top: 12px;
}
.item{
  border: 1px solid var(--border);
  border-radius: 18px;
  background: rgba(255,255,255,.96);
  padding: 10px 12px;
}
.itemTop{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}
.itemName{ font-weight: 900; }
.itemMeta{ color: var(--muted); font-size: 12px; margin-top: 6px; }
.itemScore{
  font-weight: 950;
  color: #16a34a;
  font-variant-numeric: tabular-nums;
}

/* Today tools: compact */
.todayTools{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.todayTools button{
  padding: 8px 10px;
  font-size: 12px;
  border-radius: 999px;
  box-shadow:none;
}

/* overlay */
.overlay{
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,.45);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index: 9999;
}
.overlay.show{ display:flex; }

.sheet{
  width: min(920px, 100vw);
  max-height: 86vh;
  background: rgba(255,255,255,.98);
  border: 1px solid var(--border);
  border-radius: 22px 22px 0 0;
  box-shadow: var(--shadow);
  overflow:hidden;
}
.sheetHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(96,165,250,.12), rgba(255,255,255,.0));
}
.sheetGrid{
  display:grid;
  gap:12px;
  padding: 12px 14px 14px;
  grid-template-columns: 1fr;
}
@media(min-width:760px){
  .sheetGrid{ grid-template-columns: .9fr 1.1fr; }
}
.dayList{
  max-height: 56vh;
  overflow:auto;
  border: 1px solid var(--border);
  border-radius: 18px;
  background: rgba(2,6,23,.03);
  padding: 8px;
}
.dayBtn{
  width:100%;
  text-align:left;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid transparent;
  background: transparent;
  font-weight: 900;
  color: var(--ink);
  cursor:pointer;
}
.dayBtn:hover{
  background: rgba(96,165,250,.14);
  border-color: rgba(96,165,250,.22);
}
.dayBtn.active{
  background: rgba(34,197,94,.14);
  border-color: rgba(34,197,94,.22);
}
.dayView{
  max-height: 56vh;
  overflow:auto;
  border: 1px solid var(--border);
  border-radius: 18px;
  background: rgba(2,6,23,.03);
  padding: 10px;
}
  </style>
</head>

<body>
  <div class="app" id="appScroll">
    <div class="container">

      <!-- TOPBAR -->
      <div class="topbar">
        <div class="topbarRow">
          <div class="brand">
            <h1>QPS Timer v0.3</h1>
            <div class="sub" id="todayText">Today: ----</div>
          </div>

          <div class="pills">
            <div class="pill" id="statusPill">Status: <b>Idle</b></div>
            <div class="pill streakPill" id="streakPill"><span class="fire">üî•</span> Streak: <b>0</b> ‚Ä¢ Best: <b>0</b></div>
          </div>
        </div>

        <div class="jump">
          <button class="secondary" type="button" onclick="scrollToId('sec-timer')">‚è± Timer</button>
          <button class="secondary" type="button" onclick="scrollToId('sec-today')">üìã Today</button>
          <button class="secondary" type="button" onclick="scrollToId('sec-report')">üìù Report</button>
        </div>
      </div>

      <!-- TIMER -->
      <div class="section" id="sec-timer">
        <div class="sectionHead"><h2>Timer</h2></div>

        <div class="card">
          <div class="row two">
            <div>
              <label for="category">Category</label>
              <select id="category">
                <option value="Learning">Learning</option>
                <option value="Work/Project">Work/Project</option>
                <option value="Physical">Physical</option>
                <option value="Connection">Connection</option>
              </select>
            </div>
            <div>
              <label for="questName">Quest Name (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</label>
              <input id="questName" placeholder="‡πÄ‡∏ä‡πà‡∏ô English / Logic / Web fix" />
              <div class="hint" id="questRuleHint"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="timerRow">
            <div>
              <div class="timer" id="timerText">00:00:00</div>
              <div class="hint" id="timerHint">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start</div>
            </div>
            <div class="badge" title="Base cap ‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™">
              Cap/Quest: <b id="capPerQuestText">60</b> min/day
            </div>
          </div>

          <div class="miniWarn" id="timerWarn"></div>

          <div class="actionBar">
            <button id="startBtn" class="primary" type="button">Start</button>
            <div class="pillBtns">
              <button id="pauseBtn" class="secondary" type="button" disabled>Pause</button>
              <button id="resumeBtn" class="secondary" type="button" disabled>Resume</button>
              <button id="stopBtn" class="danger" type="button" disabled>Stop</button>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Base = minutes √ó 0.4 ‚Ä¢ Bonus = 0/+2/+4/+6 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ‚â• 30 ‡∏ô‡∏≤‡∏ó‡∏µ) ‚Ä¢ Cap ‡∏ô‡∏±‡∏ö Base ‡∏ï‡πà‡∏≠ ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‚Äù ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î
          </div>
        </div>
      </div>

      <!-- TODAY -->
      <div class="section" id="sec-today">
        <div class="sectionHead"><h2>Today</h2></div>

        <div class="card">
          <div class="progressWrap">
            <div class="badge">Today's Total: <b id="todayTotal">0.0</b> / 100</div>

            <div class="todayTools">
              <button id="historyBtn" class="secondary" type="button">History</button>
              <button id="undoBtn" class="secondary" type="button" title="Undo ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô">Undo</button>
              <button id="redoBtn" class="secondary" type="button" title="Redo ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">Redo</button>
              <button id="resetTodayBtn" class="danger" type="button">Reset Today</button>
            </div>
          </div>

          <div class="bar"><div id="progressFill"></div></div>

          <div class="divider"></div>

          <div class="row two">
            <div>
              <button id="exportBtn" class="secondary" type="button" style="width:100%;">Export</button>
            </div>
            <div>
              <button id="importBtn" class="secondary" type="button" style="width:100%;">Import</button>
              <input id="importFile" type="file" accept="application/json" style="display:none;">
            </div>
          </div>

          <div class="list" id="todayList"></div>
        </div>
      </div>

      <!-- REPORT -->
      <div class="section" id="sec-report">
        <div class="sectionHead"><h2>Report</h2></div>

        <div class="card" id="reportCard" style="display:none;">
          <div class="badge">Report Quest ‚Ä¢ <b id="reportQuestTitle">----</b></div>

          <div class="row two" style="margin-top:12px;">
            <div>
              <label for="reportMinutes">Minutes Spent</label>
              <input id="reportMinutes" type="number" min="0" step="1" />
              <div class="hint" id="bonusRuleHint"></div>
            </div>

            <div>
              <label for="qualityBonus">Quality Bonus</label>
              <select id="qualityBonus">
                <option value="0">0</option>
                <option value="2">+2</option>
                <option value="4">+4</option>
                <option value="6">+6</option>
              </select>
              <div class="hint" id="capHint"></div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£/‡πÑ‡∏î‡πâ insight ‡∏≠‡∏∞‡πÑ‡∏£/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏´‡∏°"></textarea>
          </div>

          <div class="actionBar" style="margin-top:12px;">
            <button id="submitReportBtn" class="primary" type="button">Submit</button>
            <div class="pillBtns">
              <button id="discardBtn" class="secondary" type="button">Discard</button>
            </div>
          </div>

          <div class="ok" id="submitOk" style="display:none;"></div>
          <div class="warn" id="submitWarn" style="display:none;"></div>
        </div>

        <div class="hint" id="reportHiddenHint">
          * Report ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Stop ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>
      </div>

    </div>
  </div>

  <!-- HISTORY OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetHead">
        <div class="badge">History ‚Ä¢ <b id="histTitle">----</b></div>
        <button id="closeOverlayBtn" class="secondary" type="button" style="border-radius:999px;padding:8px 10px;font-size:12px;">Close</button>
      </div>

      <div class="sheetGrid">
        <div>
          <div class="hint" style="margin-bottom:8px;">Days</div>
          <div class="dayList" id="dayList"></div>
        </div>
        <div>
          <div class="hint" style="margin-bottom:8px;">Selected Day</div>
          <div class="dayView" id="dayView"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
  [BOX A] CONFIG
========================================================= */
const KEY_STATE   = "qps_timer_state_v3";
const KEY_DATA    = "qpsData_v2";      // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏≥ log ‡∏´‡∏≤‡∏¢
const KEY_STREAK  = "qps_streak_v1";
const KEY_UNDO    = "qps_undo_stack_v1"; // per-day stack
const KEY_REDO    = "qps_redo_stack_v1"; // per-day stack

const RULES = {
  basePerMinute: 0.4,
  bonusMinMinutes: 30,
  baseCapPerQuest: 60,   // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: cap ‡∏ï‡πà‡∏≠ ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‚Äù ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
};

/* =========================================================
  [BOX B] UTIL
========================================================= */
function localDateKey(d = new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function normalizeQuestName(name){
  return String(name||"").trim().replace(/\s+/g," ").toLowerCase();
}
function formatHMS(ms){
  const s=Math.max(0,Math.floor(ms/1000));
  const hh=String(Math.floor(s/3600)).padStart(2,"0");
  const mm=String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function round1(n){ return Math.round(n*10)/10; }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function scrollToId(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({ behavior:"smooth", block:"start" });
}

/* =========================================================
  [BOX C] DATA LAYER
========================================================= */
function loadAll(){
  try { return JSON.parse(localStorage.getItem(KEY_DATA)) || {}; }
  catch { return {}; }
}
function saveAll(data){
  localStorage.setItem(KEY_DATA, JSON.stringify(data));
}
function ensureDay(data, dateKey){
  if(!data[dateKey]) data[dateKey] = { totalQps: 0, quests: [] };
  if(!Array.isArray(data[dateKey].quests)) data[dateKey].quests = [];
  if(typeof data[dateKey].totalQps !== "number") data[dateKey].totalQps = 0;
  return data[dateKey];
}
function recalcDayTotal(dayObj){
  const total = (dayObj.quests||[]).reduce((s,q)=> s + (Number(q.questScore)||0), 0);
  dayObj.totalQps = round1(total);
}
function calcDayTotal(dateKey){
  const data = loadAll();
  const day = data[dateKey];
  if(!day) return 0;
  return round1(typeof day.totalQps === "number"
    ? day.totalQps
    : (day.quests||[]).reduce((s,q)=> s + (Number(q.questScore)||0), 0)
  );
}
function listDays(){
  const data = loadAll();
  return Object.keys(data).sort().reverse();
}

/* ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡∏ô‡∏±‡∏ö baseMinutesUsed ‡∏ï‡πà‡∏≠ ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‚Äù */
function calcQuestBaseMinutesUsed(dateKey, questKeyNorm){
  const data = loadAll();
  const day = data[dateKey];
  if(!day || !Array.isArray(day.quests)) return 0;
  return day.quests
    .filter(x => normalizeQuestName(x.questName) === questKeyNorm)
    .reduce((s,x) => s + (Number(x.baseMinutesUsed)||0), 0);
}

/* ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) */
function isDuplicateQuestName(dateKey, questKeyNorm){
  const data = loadAll();
  const day = data[dateKey];
  if(!day || !Array.isArray(day.quests)) return false;
  return day.quests.some(x => normalizeQuestName(x.questName) === questKeyNorm);
}

/* =========================================================
  [BOX D] STREAK
========================================================= */
function loadStreak(){
  const raw = localStorage.getItem(KEY_STREAK);
  try { return raw ? JSON.parse(raw) : { current:0, best:0, lastDone:null }; }
  catch { return { current:0, best:0, lastDone:null }; }
}
function saveStreak(s){
  localStorage.setItem(KEY_STREAK, JSON.stringify(s));
}
function addDays(dateKey, delta){
  const [y,m,d] = dateKey.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate() + delta);
  return localDateKey(dt);
}
function isDayDone(dateKey){
  const data = loadAll();
  const day = data[dateKey];
  return !!(day && Array.isArray(day.quests) && day.quests.length > 0);
}
function computeStreakFromLogs(){
  const today = localDateKey();
  if(!isDayDone(today)) return { current:0 };

  let current = 0;
  let cursor = today;
  while(isDayDone(cursor)){
    current++;
    cursor = addDays(cursor, -1);
  }
  return { current };
}
function renderStreak(){
  const s = loadStreak();
  el.streakPill.innerHTML = `üî• Streak: <b>${s.current}</b> ‚Ä¢ Best: <b>${s.best}</b>`;
}
function updateStreakAfterChange(){
  const s = loadStreak();
  const computed = computeStreakFromLogs();
  s.current = computed.current;
  if(s.current > (s.best || 0)) s.best = s.current;
  s.lastDone = isDayDone(localDateKey()) ? localDateKey() : s.lastDone;
  saveStreak(s);
  renderStreak();
}

/* =========================================================
  [BOX E] UNDO/REDO (‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô)
========================================================= */
function loadStack(key){
  try { return JSON.parse(localStorage.getItem(key)) || {}; }
  catch { return {}; }
}
function saveStack(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}
function pushUndo(dateKey, entry){
  const s = loadStack(KEY_UNDO);
  if(!Array.isArray(s[dateKey])) s[dateKey] = [];
  s[dateKey].push(entry);
  saveStack(KEY_UNDO, s);
}
function popUndo(dateKey){
  const s = loadStack(KEY_UNDO);
  const arr = Array.isArray(s[dateKey]) ? s[dateKey] : [];
  const v = arr.pop();
  s[dateKey] = arr;
  saveStack(KEY_UNDO, s);
  return v;
}
function pushRedo(dateKey, entry){
  const s = loadStack(KEY_REDO);
  if(!Array.isArray(s[dateKey])) s[dateKey] = [];
  s[dateKey].push(entry);
  saveStack(KEY_REDO, s);
}
function popRedo(dateKey){
  const s = loadStack(KEY_REDO);
  const arr = Array.isArray(s[dateKey]) ? s[dateKey] : [];
  const v = arr.pop();
  s[dateKey] = arr;
  saveStack(KEY_REDO, s);
  return v;
}
function clearRedo(dateKey){
  const s = loadStack(KEY_REDO);
  s[dateKey] = [];
  saveStack(KEY_REDO, s);
}

/* =========================================================
  [BOX F] ELEMENTS
========================================================= */
const el = {
  todayText: document.getElementById("todayText"),
  statusPill: document.getElementById("statusPill"),
  streakPill: document.getElementById("streakPill"),

  category: document.getElementById("category"),
  questName: document.getElementById("questName"),
  questRuleHint: document.getElementById("questRuleHint"),

  timerText: document.getElementById("timerText"),
  timerHint: document.getElementById("timerHint"),
  timerWarn: document.getElementById("timerWarn"),
  capPerQuestText: document.getElementById("capPerQuestText"),

  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  pauseBtn: document.getElementById("pauseBtn"),
  resumeBtn: document.getElementById("resumeBtn"),

  reportCard: document.getElementById("reportCard"),
  reportQuestTitle: document.getElementById("reportQuestTitle"),
  reportMinutes: document.getElementById("reportMinutes"),
  qualityBonus: document.getElementById("qualityBonus"),
  notes: document.getElementById("notes"),
  bonusRuleHint: document.getElementById("bonusRuleHint"),
  capHint: document.getElementById("capHint"),
  submitReportBtn: document.getElementById("submitReportBtn"),
  discardBtn: document.getElementById("discardBtn"),
  submitOk: document.getElementById("submitOk"),
  submitWarn: document.getElementById("submitWarn"),

  todayTotal: document.getElementById("todayTotal"),
  progressFill: document.getElementById("progressFill"),
  todayList: document.getElementById("todayList"),

  historyBtn: document.getElementById("historyBtn"),
  undoBtn: document.getElementById("undoBtn"),
  redoBtn: document.getElementById("redoBtn"),
  resetTodayBtn: document.getElementById("resetTodayBtn"),

  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  importFile: document.getElementById("importFile"),

  overlay: document.getElementById("overlay"),
  closeOverlayBtn: document.getElementById("closeOverlayBtn"),
  dayList: document.getElementById("dayList"),
  dayView: document.getElementById("dayView"),
  histTitle: document.getElementById("histTitle"),
};

/* =========================================================
  [BOX G] TIMER STATE
========================================================= */
let state = {
  status: "idle",      // idle | running | paused | stopped
  startTs: null,
  elapsedBefore: 0,
  startDateKey: null,
  selectedCategory: "Learning",
  questName: "",
  lastElapsedMs: 0,
};
let tickHandle = null;

function saveState(){ localStorage.setItem(KEY_STATE, JSON.stringify(state)); }
function loadState(){
  const raw = localStorage.getItem(KEY_STATE);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(s && typeof s==="object") state = { ...state, ...s };
  }catch{}
}

/* =========================================================
  [BOX H] UI RENDER
========================================================= */
function setReportVisible(v){
  el.reportCard.style.display = v ? "block" : "none";
}
function updateStatusPill(){
  const map = {
    idle: "Idle",
    running: "Running",
    paused: "Paused",
    stopped: "Stopped (report pending)",
  };
  el.statusPill.innerHTML = `Status: <b>${map[state.status] || "Idle"}</b>`;
}
function computeElapsedMs(now=Date.now()){
  if(state.status==="running" && state.startTs) return state.elapsedBefore + (now - state.startTs);
  return state.elapsedBefore;
}
function renderTimer(){
  const ms = (state.status==="stopped") ? state.lastElapsedMs : computeElapsedMs();
  el.timerText.textContent = formatHMS(ms);

  if(state.status==="idle") el.timerHint.textContent = "‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Start";
  else if(state.status==="running") el.timerHint.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Ä¢ ${state.selectedCategory} ‚Ä¢ ${state.startDateKey}`;
  else if(state.status==="paused") el.timerHint.textContent = "Paused ‚Ä¢ Resume ‡∏´‡∏£‡∏∑‡∏≠ Stop";
  else el.timerHint.textContent = "Stopped ‚Ä¢ ‡∏™‡πà‡∏á Report ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";

  el.capPerQuestText.textContent = String(RULES.baseCapPerQuest);
}
function renderControls(){
  el.startBtn.disabled = state.status !== "idle";
  el.stopBtn.disabled  = !(state.status==="running" || state.status==="paused");
  el.pauseBtn.disabled = state.status !== "running";
  el.resumeBtn.disabled= state.status !== "paused";

  const lock = state.status !== "idle";
  el.category.disabled = lock;
  el.questName.disabled = lock;

  if(state.status==="idle"){
    el.category.value = state.selectedCategory || "Learning";
    el.questName.value = state.questName || "";
  }
}
function renderQuestRuleHint(){
  const todayKey = localDateKey();
  const q = normalizeQuestName(el.questName.value);
  if(!q){
    el.questRuleHint.textContent = "‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™ (‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á)";
    return;
  }
  const dup = isDuplicateQuestName(todayKey, q);
  if(dup){
    el.questRuleHint.textContent = "‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)";
  }else{
    const used = calcQuestBaseMinutesUsed(todayKey, q);
    const remain = Math.max(0, RULES.baseCapPerQuest - used);
    el.questRuleHint.textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Base ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${used} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remain} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }
}
function renderToday(){
  const todayKey = localDateKey();
  el.todayText.textContent = `Today: ${todayKey}`;

  const total = calcDayTotal(todayKey);
  el.todayTotal.textContent = total.toFixed(1);
  el.progressFill.style.width = `${Math.max(0,Math.min(100,total))}%`;

  const data = loadAll();
  const day = data[todayKey] || { totalQps:0, quests:[] };
  const log = (day.quests||[]).slice().reverse();

  if(log.length===0){
    el.todayList.innerHTML = `<div class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  el.todayList.innerHTML = log.map(item=>{
    const name = item.questName?.trim() ? item.questName.trim() : "(no name)";
    const mins = Number(item.minutesSpent||0);
    const baseMins = Number(item.baseMinutesUsed||0);
    const baseScore = Number(item.baseScore||0);
    const bonus = Number(item.qualityBonus||0);
    const questScore = Number(item.questScore||0);
    const capNote = (baseMins < mins) ? ` ‚Ä¢ cap: counted ${baseMins}/${mins} min` : "";
    return `
      <div class="item">
        <div class="itemTop">
          <div class="itemName">${escapeHtml(name)}</div>
          <div class="itemScore">+${round1(questScore).toFixed(1)}</div>
        </div>
        <div class="itemMeta">${escapeHtml(item.category)} ‚Ä¢ ${mins} min ‚Ä¢ base ${round1(baseScore).toFixed(1)} + bonus ${bonus}${capNote}</div>
        ${item.notes ? `<div class="itemMeta" style="margin-top:8px;">üìù ${escapeHtml(item.notes)}</div>` : ``}
      </div>
    `;
  }).join("");
}
function showWarn(msg){
  el.timerWarn.style.display="block";
  el.timerWarn.textContent=msg;
  clearTimeout(showWarn._t);
  showWarn._t = setTimeout(()=>{ el.timerWarn.style.display="none"; el.timerWarn.textContent=""; }, 2200);
}
function clearSubmitMessages(){
  el.submitOk.style.display="none"; el.submitWarn.style.display="none";
  el.submitOk.textContent=""; el.submitWarn.textContent="";
}
function updateUI(){
  updateStatusPill();
  renderTimer();
  renderControls();
  renderToday();
  renderQuestRuleHint();
  setReportVisible(state.status==="stopped");
}

/* =========================================================
  [BOX I] TICK
========================================================= */
function startTick(){
  if(tickHandle) return;
  tickHandle = setInterval(()=>{
    renderToday();
    renderTimer();
  }, 250);
}

/* =========================================================
  [BOX J] RULES (bonus lock + cap hint)
========================================================= */
function applyBonusRule(minutes){
  if(minutes < RULES.bonusMinMinutes){
    el.qualityBonus.value = "0";
    el.qualityBonus.disabled = true;
    el.bonusRuleHint.textContent = `Bonus lock (‡∏ï‡πâ‡∏≠‡∏á ‚â• ${RULES.bonusMinMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }else{
    el.qualityBonus.disabled = false;
    el.bonusRuleHint.textContent = `Bonus ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÄ‡∏ß‡∏•‡∏≤ ‚â• ${RULES.bonusMinMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }
}
function updateCapHint(dateKey, questKeyNorm){
  const used = calcQuestBaseMinutesUsed(dateKey, questKeyNorm);
  const remaining = Math.max(0, RULES.baseCapPerQuest - used);
  el.capHint.textContent = `Cap ‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™/‡∏ß‡∏±‡∏ô = ${RULES.baseCapPerQuest} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Base ‡πÅ‡∏•‡πâ‡∏ß ${used} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining} ‡∏ô‡∏≤‡∏ó‡∏µ`;
}

/* =========================================================
  [BOX K] ACTIONS (Timer -> Report -> Save)
========================================================= */
function validateQuestNameOrWarn(){
  const qRaw = (el.questName.value || "").trim();
  const qNorm = normalizeQuestName(qRaw);
  const todayKey = localDateKey();

  if(!qNorm){
    showWarn("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Quest Name ‡∏Å‡πà‡∏≠‡∏ô");
    return { ok:false };
  }
  if(isDuplicateQuestName(todayKey, qNorm)){
    showWarn("‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
    return { ok:false };
  }
  return { ok:true, qRaw, qNorm, todayKey };
}

function startQuest(){
  const v = validateQuestNameOrWarn();
  if(!v.ok) return;

  state.status="running";
  state.selectedCategory = el.category.value;
  state.questName = v.qRaw;
  state.startDateKey = localDateKey();
  state.startTs = Date.now();
  state.elapsedBefore = 0;
  state.lastElapsedMs = 0;
  saveState();

  setReportVisible(false);
  clearSubmitMessages();
  updateUI();
  startTick();
}
function pauseQuest(){
  if(state.status!=="running") return;
  const now = Date.now();
  state.elapsedBefore = computeElapsedMs(now);
  state.startTs = null;
  state.status = "paused";
  saveState();
  updateUI();
}
function resumeQuest(){
  if(state.status!=="paused") return;
  state.status="running";
  state.startTs=Date.now();
  saveState();
  updateUI();
}
function stopQuest(){
  if(!(state.status==="running" || state.status==="paused")) return;

  const now = Date.now();
  const elapsed = (state.status==="running") ? computeElapsedMs(now) : state.elapsedBefore;

  state.status="stopped";
  state.startTs=null;
  state.elapsedBefore=elapsed;
  state.lastElapsedMs=elapsed;
  saveState();

  const minutes = Math.max(0, Math.round(elapsed/60000));
  el.reportMinutes.value = String(minutes);
  applyBonusRule(minutes);

  const dateKey = state.startDateKey || localDateKey();
  const qNorm = normalizeQuestName(state.questName);
  updateCapHint(dateKey, qNorm);

  el.reportQuestTitle.textContent = state.questName || "----";

  setReportVisible(true);
  clearSubmitMessages();
  updateUI();
  scrollToId("sec-report");
}
function discardReport(){
  state.status="idle";
  state.startTs=null;
  state.elapsedBefore=0;
  state.lastElapsedMs=0;
  state.startDateKey=null;
  saveState();

  setReportVisible(false);
  clearSubmitMessages();
  updateUI();
}
function submitReport(){
  clearSubmitMessages();

  const minutes = Number(el.reportMinutes.value);
  if(!Number.isFinite(minutes) || minutes <= 0){
    el.submitWarn.style.display="block";
    el.submitWarn.textContent="Minutes ‡∏ï‡πâ‡∏≠‡∏á > 0";
    return;
  }

  const qRaw = (state.questName || "").trim();
  const qNorm = normalizeQuestName(qRaw);
  const dateKey = state.startDateKey || localDateKey();

  if(!qNorm){
    el.submitWarn.style.display="block";
    el.submitWarn.textContent="Quest Name ‡∏´‡∏≤‡∏¢/‡∏ß‡πà‡∏≤‡∏á ‚Äî Discard ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà";
    return;
  }

  // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ ‚Äú‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™‡πÅ‡∏õ‡∏•‡∏Å‚Äù (‡πÅ‡∏°‡πâ‡∏ï‡∏≠‡∏ô Start ‡∏à‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
  if(isDuplicateQuestName(dateKey, qNorm)){
    el.submitWarn.style.display="block";
    el.submitWarn.textContent="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥) ‚Äî ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà";
    return;
  }

  applyBonusRule(minutes);
  const bonus = el.qualityBonus.disabled ? 0 : Number(el.qualityBonus.value||0);

  // ‚úÖ cap ‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™
  const used = calcQuestBaseMinutesUsed(dateKey, qNorm);
  const remaining = Math.max(0, RULES.baseCapPerQuest - used);
  const baseMinutesUsed = Math.min(minutes, remaining);

  const baseScore = baseMinutesUsed * RULES.basePerMinute;
  const questScore = baseScore + bonus;

  const entry = {
    ts: Date.now(),
    dateKey,
    category: state.selectedCategory,
    questName: qRaw,
    minutesSpent: minutes,
    baseMinutesUsed,
    baseScore: round1(baseScore),
    qualityBonus: bonus,
    questScore: round1(questScore),
    notes: el.notes.value || ""
  };

  const data = loadAll();
  const day = ensureDay(data, dateKey);
  day.quests.push(entry);
  recalcDayTotal(day);
  saveAll(data);

  // ‚úÖ undo: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ action ‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á redo ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
  clearRedo(dateKey);

  updateStreakAfterChange();

  el.submitOk.style.display="block";
  const capMsg = (baseMinutesUsed < minutes) ? ` (cap: counted ${baseMinutesUsed}/${minutes} min)` : "";
  el.submitOk.textContent = `Saved! +${round1(questScore).toFixed(1)}${capMsg}`;

  el.notes.value = "";

  setTimeout(()=>{
    discardReport();
    renderToday();
  }, 320);
}

/* =========================================================
  [BOX L] TODAY ACTIONS (Undo/Redo/Reset)
========================================================= */
function undoToday(){
  const todayKey = localDateKey();
  const data = loadAll();
  const day = data[todayKey];
  if(!day || !Array.isArray(day.quests) || day.quests.length===0){
    showWarn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ Undo");
    return;
  }
  const removed = day.quests.pop();
  recalcDayTotal(day);
  saveAll(data);

  pushUndo(todayKey, removed);
  updateStreakAfterChange();
  updateUI();
  showWarn("Undo ‚úÖ");
}
function redoToday(){
  const todayKey = localDateKey();
  const entry = popUndo(todayKey);
  if(!entry){
    showWarn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ Redo");
    return;
  }
  // redo = ‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ day.quests
  const data = loadAll();
  const day = ensureDay(data, todayKey);

  // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥: ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏ô‡∏ä‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏∂‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á undo) ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ redo
  const qNorm = normalizeQuestName(entry.questName);
  if(isDuplicateQuestName(todayKey, qNorm)){
    showWarn("Redo ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
    // ‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ undo ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    pushUndo(todayKey, entry);
    return;
  }

  day.quests.push(entry);
  recalcDayTotal(day);
  saveAll(data);

  updateStreakAfterChange();
  updateUI();
  showWarn("Redo ‚úÖ");
}
function resetToday(){
  const todayKey = localDateKey();
  const ok = confirm(`Reset ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${todayKey})? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î`);
  if(!ok) return;

  const data = loadAll();
  data[todayKey] = { totalQps:0, quests:[] };
  saveAll(data);

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå undo/redo ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  const u = loadStack(KEY_UNDO); u[todayKey] = []; saveStack(KEY_UNDO, u);
  const r = loadStack(KEY_REDO); r[todayKey] = []; saveStack(KEY_REDO, r);

  updateStreakAfterChange();
  updateUI();
  showWarn("‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
}

/* =========================================================
  [BOX M] HISTORY OVERLAY
========================================================= */
let selectedDay = null;

function openHistory(){
  const days = listDays();
  if(days.length===0){
    showWarn("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á");
    return;
  }
  el.overlay.classList.add("show");
  selectedDay = selectedDay || localDateKey();
  renderHistoryDays();
  renderDayView(selectedDay);
}
function closeHistory(){ el.overlay.classList.remove("show"); }
function renderHistoryDays(){
  const days = listDays();
  const data = loadAll();
  el.dayList.innerHTML = days.map(d=>{
    const t = (data[d]?.totalQps ?? 0);
    const active = (d === selectedDay) ? "active" : "";
    return `<button class="dayBtn ${active}" data-day="${d}">${d} ‚Ä¢ ${Number(t).toFixed(1)} QPS</button>`;
  }).join("");

  el.dayList.querySelectorAll(".dayBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      selectedDay = btn.dataset.day;
      renderHistoryDays();
      renderDayView(selectedDay);
    });
  });
}
function renderDayView(dayKey){
  const data = loadAll();
  const day = data[dayKey] || { totalQps:0, quests:[] };
  el.histTitle.textContent = dayKey;

  if(!day.quests || day.quests.length===0){
    el.dayView.innerHTML = `<div class="hint">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>`;
    return;
  }

  const log = day.quests.slice().reverse();
  el.dayView.innerHTML = `
    <div class="badge" style="margin-bottom:10px;">Total: <b>${Number(day.totalQps||0).toFixed(1)}</b></div>
    <div class="list">
      ${log.map(item=>{
        const name = item.questName?.trim()? item.questName.trim() : "(no name)";
        const mins = Number(item.minutesSpent||0);
        const baseMins = Number(item.baseMinutesUsed||0);
        const capNote = (baseMins < mins) ? ` ‚Ä¢ cap: ${baseMins}/${mins} min` : "";
        return `
          <div class="item">
            <div class="itemTop">
              <div class="itemName">${escapeHtml(name)}</div>
              <div class="itemScore">+${Number(item.questScore||0).toFixed(1)}</div>
            </div>
            <div class="itemMeta">
              ${escapeHtml(item.category)} ‚Ä¢ ${mins} min ‚Ä¢ base ${Number(item.baseScore||0).toFixed(1)} + bonus ${item.qualityBonus||0}${capNote}
            </div>
            ${item.notes ? `<div class="itemMeta" style="margin-top:8px;">üìù ${escapeHtml(item.notes)}</div>` : ``}
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* =========================================================
  [BOX N] EXPORT / IMPORT
========================================================= */
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function isValidDataShape(all){
  if(!all || typeof all !== "object") return false;
  for(const dayKey of Object.keys(all)){
    const day = all[dayKey];
    if(!day || typeof day !== "object") return false;
    if(!Array.isArray(day.quests)) return false;
    if(typeof day.totalQps !== "number") return false;
  }
  return true;
}
function exportData(){
  const payload = {
    version: KEY_DATA,
    exportedAt: new Date().toISOString(),
    data: loadAll()
  };
  downloadJson(`qpsData_v2_${localDateKey()}.json`, payload);
  showWarn("Exported ‚úÖ");
}
function importDataObject(imported, mode="merge"){
  const raw = imported?.data ?? imported;
  if(!isValidDataShape(raw)){
    alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á qpsData_v2");
    return;
  }

  if(mode === "replace"){
    saveAll(raw);
  }else{
    const cur = loadAll();
    for(const dayKey of Object.keys(raw)){
      const incomingDay = raw[dayKey];
      const target = ensureDay(cur, dayKey);
      target.quests = target.quests.concat(incomingDay.quests || []);
      recalcDayTotal(target);
    }
    saveAll(cur);
  }

  updateStreakAfterChange();
  selectedDay = localDateKey();
  updateUI();

  if(el.overlay.classList.contains("show")){
    renderHistoryDays();
    renderDayView(selectedDay);
  }

  showWarn(`Imported ‚úÖ (${mode.toUpperCase()})`);
}
async function importFromFile(file){
  const text = await file.text();
  let obj;
  try { obj = JSON.parse(text); }
  catch { alert("‡πÑ‡∏ü‡∏•‡πå JSON ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); return; }

  const choice = prompt("Import mode: ‡∏û‡∏¥‡∏°‡∏û‡πå merge ‡∏´‡∏£‡∏∑‡∏≠ replace", "merge");
  const mode = (choice || "merge").toLowerCase() === "replace" ? "replace" : "merge";

  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import ‡πÅ‡∏ö‡∏ö ${mode.toUpperCase()} ?`)) return;
  importDataObject(obj, mode);
}

/* =========================================================
  [BOX O] EVENTS
========================================================= */
el.startBtn.addEventListener("click", startQuest);
el.pauseBtn.addEventListener("click", pauseQuest);
el.resumeBtn.addEventListener("click", resumeQuest);
el.stopBtn.addEventListener("click", stopQuest);

el.reportMinutes.addEventListener("input", ()=>{
  const minutes = Number(el.reportMinutes.value);
  if(Number.isFinite(minutes)) applyBonusRule(minutes);
});

el.submitReportBtn.addEventListener("click", submitReport);
el.discardBtn.addEventListener("click", discardReport);

el.category.addEventListener("change", ()=>{
  if(state.status==="idle"){
    state.selectedCategory = el.category.value;
    saveState();
  }
});
el.questName.addEventListener("input", ()=>{
  if(state.status==="idle"){
    state.questName = el.questName.value || "";
    saveState();
    renderQuestRuleHint();
  }
});

el.historyBtn.addEventListener("click", openHistory);
el.closeOverlayBtn.addEventListener("click", closeHistory);
el.overlay.addEventListener("click", (e)=>{ if(e.target===el.overlay) closeHistory(); });

el.undoBtn.addEventListener("click", undoToday);
el.redoBtn.addEventListener("click", redoToday);
el.resetTodayBtn.addEventListener("click", resetToday);

el.exportBtn.addEventListener("click", exportData);
el.importBtn.addEventListener("click", ()=>{
  el.importFile.value = "";
  el.importFile.click();
});
el.importFile.addEventListener("change", async ()=>{
  const file = el.importFile.files?.[0];
  if(!file) return;
  await importFromFile(file);
});

/* =========================================================
  [BOX P] BOOT
========================================================= */
function boot(){
  loadState();

  // ‡∏ñ‡πâ‡∏≤ state ‡∏´‡∏•‡∏∏‡∏î (running ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ startTs) -> paused
  if(state.status==="running" && !state.startTs){
    state.status="paused";
    state.startTs=null;
    saveState();
  }

  if(state.status==="idle"){
    el.category.value = state.selectedCategory || "Learning";
    el.questName.value = state.questName || "";
  }

  startTick();
  updateUI();
  updateStreakAfterChange();
}
boot();
</script>
</body>
</html>
